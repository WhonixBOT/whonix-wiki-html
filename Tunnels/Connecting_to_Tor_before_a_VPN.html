<!DOCTYPE html>
<html class="client-nojs" dir="ltr" lang="en"><!-- 
 single html processed by https://github.com/zTrix/webpage2html
 title: Tunnels/Connecting to Tor before a VPN - Whonix
 url: ../Tunnels/Connecting_to_Tor_before_a_VPN
 date: Sun Sep 30 08:13:13 2018
-->
<head>
<meta charset="utf-8"/>
<title>Tunnels/Connecting to Tor before a VPN - Whonix</title>
<link rel="stylesheet" type="text/css" href="../style.css">




<style>.firstHeading, .subtitle, #siteSub, #contentSub, .pagetitle { display: none; }</style>
<meta content="" name="ResourceLoaderDynamicStyles"/>

<meta content="MediaWiki 1.31.1" name="generator"/>
<meta content="" name="google-site-verification"/>
<meta content="https://www.whonix.org/w/images/1/15/Ball-443853640.jpg" name="image"/>
<meta content="https://www.whonix.org/w/images/1/15/Ball-443853640.jpg" name="twitter:image:src"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="@Whonix" name="twitter:site"/>
<meta content="Whonix" name="twitter:domain"/>
<meta content="@Whonix" name="twitter:creator"/>
<meta content="Instructions on how to connect to Tor before a VPN (User -&amp;gt; Tor -&amp;gt; VPN -&amp;gt; Internet)" name="description"/>
<meta content="Instructions on how to connect to Tor before a VPN (User -&amp;gt; Tor -&amp;gt; VPN -&amp;gt; Internet)" name="twitter:description"/>
<meta content="width=device-width, user-scalable=yes, initial-scale=1.0" name="viewport"/>
<link data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit" rel="alternate.html" title="Edit" type="application/x-wiki"/>
<link data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit" rel="edit.html" title="Edit"/>
<link data-href="/favicon.ico" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOPj4wC5q6j/xba0/8W2tP+3qab/4+PiBQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALyurP/Ku7n/yru5/8q7uf/Ku7n/yru5/8q7uf+6rKr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALyurP/Ku7n/yru5/8CohP/VnhL/1Z4S/8CohP/Ku7n/yru5/7mrqf8AAAAAAAAAAAAAAAAAAAAAAAAAAI6Mi//Ku7n/yru5/8GRHP/iqhL/////////////////wJEd/8q7uf/Ku7n/xsXE/wAAAAAAAAAAAAAAAAAAAAC5q6n/yru5/8q7uf/hqRH//////0bcy/9G3Mv//////+GpEf/Ku7n/yru5/7qsqv8AAAAAAAAAAAAAAAAAAAAAxLW0/8q7uf/Ku7n/4qoS/////////////////0bcy//iqhL/yru5/8q7uf/Gt7T/AAAAAAAAAAAAAAAAAAAAAMKzsP/Ku7n/yru5/96lFf//////RtzL/0bcy///////3qUV/8q7uf/Ku7n/wrWy/wAAAAAAAAAAAAAAAAAAAACvo6D/yru5/8q7uf/Ku7n/4akQ//fnvP/57tD/4akQ/8q7uf/Ku7n/yru5/7Gkov8AAAAAAAAAAAAAAAAAAAAAAAAAAMq7uf/Ku7n/yru5/8q7uf/hqRD/4akQ/8q7uf/Ku7n/yru5/8q7uf8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACOjIv/yru5/8q7uf/Ku7n/yru5/8q7uf/Ku7n/yru5/8q7uf+Mioj/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAISDgf/Iurj/yru5/8q7uf/Ku7n/yru5/8i5uP+EgoH/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC6rKr/q56c/wAAAACOjIv/joyL/wAAAACom5r/taim/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAuqyp/66hnv8AAAAAAAAAAAAAAAAAAAAAqp2b/7SnpP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKmcm/+9r6z/AAAAAAAAAAAAAAAAAAAAALmrqf+jl5b/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwLOw/6uenP8AAAAAAAAAAKqenP+/sq//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACtoJ7/vK2r/72vrP+sn57/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/D8AAPAPAADgBwAAwAMAAMADAADAAwAAwAMAAMADAADgBwAA4AcAAPAPAADyTwAA888AAPPPAAD5nwAA/D8AAA==" rel="shortcut icon"/>
<link data-href="/w/opensearch_desc.php" href="https://www.whonix.org/w/opensearch_desc.php" rel="search.html" title="Whonix (en)" type="application/opensearchdescription+xml"/>
<link data-href="http://kkkkkkkkkk63ava6.onion/w/api.php?action=rsd" href="http://kkkkkkkkkk63ava6.onion/w/api.php?action=rsd" rel="EditURI" type="application/rsd+xml"/>
<link data-href="/w/index.php?title=Special:RecentChanges&amp;feed=atom" href="https://www.whonix.org/w/index.php?title=Special:RecentChanges&amp;feed=atom" rel="alternate.html" title="Whonix Atom feed" type="application/atom+xml"/>
<meta content="article" property="og:type"/>
<meta content="Whonix" property="og:site_name"/>
<meta content="Tunnels/Connecting to Tor before a VPN" property="og:title"/>
<meta content="http://kkkkkkkkkk63ava6.onion/wiki/Tunnels/Connecting_to_Tor_before_a_VPN" property="og:url"/>
<meta content="https://www.whonix.org/w/images/1/15/Ball-443853640.jpg" property="og:image"/>
<meta content="Instructions on how to connect to Tor before a VPN (User -&amp;gt; Tor -&amp;gt; VPN -&amp;gt; Internet)" property="og:description"/>

<meta content="" property="fb:app_id"/>
<meta content="" property="fb:admins"/>
<meta content="https://www.facebook.com/Whonix" property="article:author"/>
<meta content="https://www.facebook.com/Whonix" property="article:publisher"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<!--[if lt IE 9]><script src="/w/load.php?debug=false&amp;lang=en&amp;modules=html5shiv&amp;only=scripts&amp;skin=foreground&amp;sync=1"></script><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Tunnels_Connecting_to_Tor_before_a_VPN rootpage-Tunnels skin-foreground action-view"><div id="navwrapper"><!-- START FOREGROUNDTEMPLATE -->

</div>
<div id="page-content">
<div class="row">
<div class="large-12 columns">
<!-- Output page indicators -->
<div class="mw-indicators mw-body-content">
</div>
<!-- If user is logged in output echo location -->
<!--[if lt IE 9]>
				<div id="siteNotice" class="sitenotice panel radius">Whonix may not look as expected in this version of Internet Explorer. We recommend you upgrade to a newer version of Internet Explorer or switch to a browser like Firefox or Chrome.</div>
				<![endif]-->
<div class="sitenotice" id="siteNotice"><div dir="ltr" id="localNotice" lang="en"><div class="mw-parser-output"><p><style type="text/css">

#banner {
 position: relative;
 overflow: hidden;
 margin-bottom: 0.5em !important;
 margin-top: 0.5em !important;
 background-color:#D03232;
 border: solid 1px #aaaaaa; 
 height:66px;
}

#banner a.cn-full-banner-click {
 display:block;
 height:100%;
 width:100%;
 cursor: pointer;
}


#banner-logo {
 position: absolute;
 top: 8px;
 left: 15px;
 background-image: url(data:image/png;base64,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);
 height: 50px;
 width: 100%;
 background-repeat: no-repeat;
}

#banner #black-text {
 font-size: 1.1em;
 color: white;
 padding: 0.5em 40px 0.4em 60px;
 line-height: 1.3em;
 text-align: center;
}
</style>
</p><div id="banner">
<a class="cn-full-banner-click" data-href="/wiki/Payments" href="../Payments.html" title="">
<div id="banner-logo"></div>
<div id="black-text">
Whonix requires payments to stay alive.
     </div>
</a>
</div>
</div></div></div> </div>
</div>
<div id="mw-js-message" style="display:none;"></div>
<div class="row">
<div class="large-12 columns" id="p-cactions">
<a class="button small secondary radius" data-dropdown="actions" data-options="align:left; is_hover: true; hover_timeout:700" href="#" id="actions-button"><i class="fa fa-cog"><span class="show-for-medium-up"> Actions</span></i></a>
<!--RTL -->
<ul class="f-dropdown" data-dropdown-content="" id="actions">
<li class="selected" id="ca-nstab-main"><a accesskey="c" data-href="/wiki/Tunnels/Connecting_to_Tor_before_a_VPN" href="../Tunnels/Connecting_to_Tor_before_a_VPN.html" title="View the content page [c]">Page</a></li><li class="new" id="ca-talk"><a accesskey="t" data-href="/w/index.php?title=Talk:Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;redlink=1" href="https://www.whonix.org/w/index.php?title=Talk:Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;redlink=1" rel="discussion.html" title="Discussion about the content page (page does not exist) [t]">Discussion</a></li><li id="ca-edit"><a accesskey="e" data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit.html" title="Edit this page [e]">Edit</a></li><li id="ca-history"><a accesskey="h" data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=history" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=history.html" title="Past revisions of this page [h]">History</a></li> </ul>
<!--RTL -->
<div id="content">
<h1 class="title" id="firstHeading">Tunnels/Connecting to Tor before a VPN</h1>
<h5 class="subtitle" id="siteSub"><span class="subpages">&lt; <a class="mw-redirect" data-href="/wiki/Tunnels" href="../Tunnels.html" title="Tunnels">Tunnels</a></span></h5>
<div class="clear_both" id="contentSub"></div>
<div class="mw-bodytext" id="bodyContent">
<div class="mw-content-ltr" dir="ltr" id="mw-content-text" lang="en"><div class="mw-parser-output">
<table class="metadata plainlinks ambox ambox-notice" style="">
<tbody><tr><td class="mbox-image"><div style="width: 52px;"><a class="image" data-href="/w/index.php?title=File:Ambox_warning_pn.svg.png&amp;filetimestamp=20130717200816&amp;" href="https://www.whonix.org/w/index.php?title=File:Ambox_warning_pn.svg.png&amp;filetimestamp=20130717200816&amp;"><img alt="Ambox warning pn.svg.png" data-src="/w/images/thumb/f/f7/Ambox_warning_pn.svg.png/40px-Ambox_warning_pn.svg.png" data-srcset="/w/images/thumb/f/f7/Ambox_warning_pn.svg.png/60px-Ambox_warning_pn.svg.png 1.5x, /w/images/thumb/f/f7/Ambox_warning_pn.svg.png/80px-Ambox_warning_pn.svg.png 2x" height="35" src="data:image/png;base64,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" width="40"/></a></div></td><td class="mbox-text" style=""><span class="mbox-text-span"><font size="4"><b><u>Before combining Tor with other tunnels, <a data-href="/wiki/Tunnels/Introduction" href="../Tunnels/Introduction.html" title="Tunnels/Introduction">be sure to read and understand the risks</a>!</u></b></font><span class="hide-when-compact"> </span><span class="hide-when-compact"> </span></span></td></tr></tbody></table>
<table class="metadata plainlinks ambox ambox-notice" style="">
<tbody><tr><td class="mbox-image"><div style="width: 52px;"><a class="image" data-href="/w/index.php?title=File:Ambox_notice.png&amp;filetimestamp=20130717195411&amp;" href="https://www.whonix.org/w/index.php?title=File:Ambox_notice.png&amp;filetimestamp=20130717195411&amp;"><img alt="Ambox notice.png" data-src="/w/images/c/c8/Ambox_notice.png" height="40" src="data:image/png;base64,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" width="40"/></a></div></td><td class="mbox-text" style=""><span class="mbox-text-span"><u>Advertisement</u>:<br/>
Too difficult to set up? Provider specific automation can be created for you by the lead developer of Whonix. Send reasonable price suggestions. Get in <a data-href="/wiki/Contact#For_Private_Inquiries" href="../Contact.html" title="Contact">contact</a>.<span class="hide-when-compact"> </span><span class="hide-when-compact"> </span></span></td></tr></tbody></table>
<p><br/>
<b><code>User</code> -&gt; <code>Tor</code> -&gt; <code>VPN</code> -&gt; <code>Internet</code></b>
</p>
<div class="toc" id="toc"><div class="toctitle" dir="ltr" lang="en"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Increased_Threat_of_Identity_Correlation"><span class="tocnumber">1</span> <span class="toctext">Increased Threat of Identity Correlation</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Prevent_Bypassing_of_the_Tunnel-Link"><span class="tocnumber">2</span> <span class="toctext">Prevent Bypassing of the Tunnel-Link</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Use_a_Fail_Closed_Mechanism"><span class="tocnumber">3</span> <span class="toctext">Use a Fail Closed Mechanism</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#VPN_Client_Choice"><span class="tocnumber">4</span> <span class="toctext">VPN Client Choice</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Setup_Tor_before_a_VPN_.28User_-.3E_Tor_-.3E_VPN_-.3E_Internet.29"><span class="tocnumber">5</span> <span class="toctext">Setup Tor before a VPN (User -&gt; Tor -&gt; VPN -&gt; Internet)</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#Introduction"><span class="tocnumber">5.1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Separate_VPN-Gateway"><span class="tocnumber">5.2</span> <span class="toctext">Separate VPN-Gateway</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Inside_Whonix-Workstation"><span class="tocnumber">5.3</span> <span class="toctext">Inside Whonix-Workstation</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="#Whonix_TUNNEL_FIREWALL_vs_standalone_VPN-Firewall"><span class="tocnumber">5.3.1</span> <span class="toctext">Whonix TUNNEL_FIREWALL vs standalone VPN-Firewall</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="#Preparation"><span class="tocnumber">5.3.2</span> <span class="toctext">Preparation</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="#Prerequisite_Knowledge"><span class="tocnumber">5.3.3</span> <span class="toctext">Prerequisite Knowledge</span></a></li>
<li class="toclevel-3 tocsection-12"><a href="#Firewall_Settings"><span class="tocnumber">5.3.4</span> <span class="toctext">Firewall Settings</span></a></li>
<li class="toclevel-3 tocsection-13"><a href="#Reload_Firewall"><span class="tocnumber">5.3.5</span> <span class="toctext">Reload Firewall</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="#sudoers_configuration"><span class="tocnumber">5.3.6</span> <span class="toctext">sudoers configuration</span></a></li>
<li class="toclevel-3 tocsection-15"><a href="#VPN_Setup"><span class="tocnumber">5.3.7</span> <span class="toctext">VPN Setup</span></a>
<ul>
<li class="toclevel-4 tocsection-16"><a href="#Introduction_2"><span class="tocnumber">5.3.7.1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-4 tocsection-17"><a href="#Get_VPN_Certificate"><span class="tocnumber">5.3.7.2</span> <span class="toctext">Get VPN Certificate</span></a></li>
<li class="toclevel-4 tocsection-18"><a href="#VPN_Credentials"><span class="tocnumber">5.3.7.3</span> <span class="toctext">VPN Credentials</span></a></li>
<li class="toclevel-4 tocsection-19"><a href="#VPN_IP_Address"><span class="tocnumber">5.3.7.4</span> <span class="toctext">VPN IP Address</span></a></li>
<li class="toclevel-4 tocsection-20"><a href="#VPN_Configuration_File"><span class="tocnumber">5.3.7.5</span> <span class="toctext">VPN Configuration File</span></a></li>
<li class="toclevel-4 tocsection-21"><a href="#install_resolvconf"><span class="tocnumber">5.3.7.6</span> <span class="toctext">install resolvconf</span></a></li>
<li class="toclevel-4 tocsection-22"><a href="#DNS_Configuration"><span class="tocnumber">5.3.7.7</span> <span class="toctext">DNS Configuration</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-23"><a href="#Setup"><span class="tocnumber">5.3.8</span> <span class="toctext">Setup</span></a>
<ul>
<li class="toclevel-4 tocsection-24"><a href="#Configuration_Folder_Permissions"><span class="tocnumber">5.3.8.1</span> <span class="toctext">Configuration Folder Permissions</span></a></li>
<li class="toclevel-4 tocsection-25"><a href="#systemd_setup"><span class="tocnumber">5.3.8.2</span> <span class="toctext">systemd setup</span></a></li>
<li class="toclevel-4 tocsection-26"><a href="#resolvconf_adjustments"><span class="tocnumber">5.3.8.3</span> <span class="toctext">resolvconf adjustments</span></a></li>
<li class="toclevel-4 tocsection-27"><a href="#Verify_DNS_Settings"><span class="tocnumber">5.3.8.4</span> <span class="toctext">Verify DNS Settings</span></a></li>
<li class="toclevel-4 tocsection-28"><a href="#whonixcheck"><span class="tocnumber">5.3.8.5</span> <span class="toctext">whonixcheck</span></a></li>
<li class="toclevel-4 tocsection-29"><a href="#Qubes_specific"><span class="tocnumber">5.3.8.6</span> <span class="toctext">Qubes specific</span></a></li>
<li class="toclevel-4 tocsection-30"><a href="#Test"><span class="tocnumber">5.3.8.7</span> <span class="toctext">Test</span></a></li>
<li class="toclevel-4 tocsection-31"><a href="#Done"><span class="tocnumber">5.3.8.8</span> <span class="toctext">Done</span></a></li>
<li class="toclevel-4 tocsection-32"><a href="#Troubleshooting"><span class="tocnumber">5.3.8.9</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-5"><a href="#ip_unpriv_vs_ip-unpriv"><span class="tocnumber">5.3.8.9.1</span> <span class="toctext">ip_unpriv vs  ip-unpriv</span></a></li>
<li class="toclevel-5"><a href="#50_openvpn_unpriv.conf_vs_50_openvpn-unpriv.conf"><span class="tocnumber">5.3.8.9.2</span> <span class="toctext">50_openvpn_unpriv.conf vs 50_openvpn-unpriv.conf</span></a></li>
<li class="toclevel-5"><a href="#Cannot_ioctl_TUNSETIFF"><span class="tocnumber">5.3.8.9.3</span> <span class="toctext">Cannot ioctl TUNSETIFF</span></a></li>
<li class="toclevel-5"><a href="#Dev_tun_Mismatch"><span class="tocnumber">5.3.8.9.4</span> <span class="toctext">Dev tun Mismatch</span></a></li>
<li class="toclevel-5"><a href="#.2Frun.2Fopenvpn.2Fopenvpn.status_Permission_denied"><span class="tocnumber">5.3.8.9.5</span> <span class="toctext">/run/openvpn/openvpn.status Permission denied</span></a></li>
<li class="toclevel-5"><a href="#debug_start"><span class="tocnumber">5.3.8.9.6</span> <span class="toctext">debug start</span></a></li>
<li class="toclevel-5"><a href="#Linux_ip_link_set_failed"><span class="tocnumber">5.3.8.9.7</span> <span class="toctext">Linux ip link set failed</span></a></li>
<li class="toclevel-5"><a href="#DNS_Configuration_2"><span class="tocnumber">5.3.8.9.8</span> <span class="toctext">DNS Configuration</span></a></li>
<li class="toclevel-5"><a href="#Terminology_for_Support_Requests"><span class="tocnumber">5.3.8.9.9</span> <span class="toctext">Terminology for Support Requests</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-33"><a href="#Leak_Tests"><span class="tocnumber">6</span> <span class="toctext">Leak Tests</span></a>
<ul>
<li class="toclevel-2 tocsection-34"><a href="#Introduction_3"><span class="tocnumber">6.1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#regular_application_test"><span class="tocnumber">6.2</span> <span class="toctext">regular application test</span></a></li>
<li class="toclevel-2 tocsection-36"><a href="#uwt_wrapped_application_test"><span class="tocnumber">6.3</span> <span class="toctext">uwt wrapped application test</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="#Browser_IP_Test"><span class="tocnumber">6.4</span> <span class="toctext">Browser IP Test</span></a></li>
<li class="toclevel-2 tocsection-38"><a href="#DNS_Leak_Test"><span class="tocnumber">6.5</span> <span class="toctext">DNS Leak Test</span></a></li>
<li class="toclevel-2 tocsection-39"><a href="#Other_Leak_Tests"><span class="tocnumber">6.6</span> <span class="toctext">Other Leak Tests</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-40"><a href="#Footnotes"><span class="tocnumber">7</span> <span class="toctext">Footnotes</span></a></li>
</ul>
</div>
<hr/>
<h1><span class="mw-headline" id="Increased_Threat_of_Identity_Correlation">Increased Threat of Identity Correlation</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=1" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=1.html" title="Edit section: Increased Threat of Identity Correlation">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<p>By design, a VPN routes all your applications - those without any proxy settings - through the VPN. You may not want this, as explained below. To circumvent that, you should use this Whonix-Workstation only for the particular application you want to route through the tunnel-link. You are advised to use <a data-href="/wiki/Multiple_Whonix-Workstations" href="../Multiple_Whonix-Workstations.html" title="Multiple Whonix-Workstations">Multiple Whonix-Workstations</a>.
</p>
<h1><span class="mw-headline" id="Prevent_Bypassing_of_the_Tunnel-Link">Prevent Bypassing of the Tunnel-Link</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=2" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=2.html" title="Edit section: Prevent Bypassing of the Tunnel-Link">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<table class="metadata plainlinks ambox ambox-notice" style="">
<tbody><tr><td class="mbox-image"><div style="width: 52px;"><a class="image" data-href="/w/index.php?title=File:Ambox_warning_pn.svg.png&amp;filetimestamp=20130717200816&amp;" href="https://www.whonix.org/w/index.php?title=File:Ambox_warning_pn.svg.png&amp;filetimestamp=20130717200816&amp;"><img alt="Ambox warning pn.svg.png" data-src="/w/images/thumb/f/f7/Ambox_warning_pn.svg.png/40px-Ambox_warning_pn.svg.png" data-srcset="/w/images/thumb/f/f7/Ambox_warning_pn.svg.png/60px-Ambox_warning_pn.svg.png 1.5x, /w/images/thumb/f/f7/Ambox_warning_pn.svg.png/80px-Ambox_warning_pn.svg.png 2x" height="35" src="data:image/png;base64,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" width="40"/></a></div></td><td class="mbox-text" style=""><span class="mbox-text-span">Apply the following steps to avoid unexpected results such as broken connectivity and/or traffic bypassing the tunnel-link and only going through Tor. 
<p><br/>
</p>
<a class="mw-redirect" data-href="/wiki/Qubes-Whonix" href="../Qubes-Whonix.html" title="Qubes-Whonix">Qubes-Whonix</a> exception: There is one tunnel configuration where Qubes-Whonix users are better placed. When a separate tunnel-link VM is used between anon-whonix and sys-whonix (<code>anon-whonix</code> -&gt; <code>Tunnel-link</code> -&gt; <code>sys-whonix</code>), these connections simply fail without the following modifications.<span class="hide-when-compact"> </span><span class="hide-when-compact"> </span></span></td></tr></tbody></table>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><b>Introduction</b><br/>
Disabling stream isolation will prevent bypassing of the tunnel-link. By default, many pre-installed applications are configured for <a data-href="/wiki/Stream_Isolation" href="../Stream_Isolation.html" title="Stream Isolation">Stream Isolation</a> in Whonix. These specific applications are configured to use Tor SocksPorts, instead of Tor's TransPort.
</p><p>All applications which are configured to use Tor SocksPorts are not tunneled through the tunnel-link, but instead they are "only" tunneled through Tor. The reason is the following configuration does not touch local connections to <i><span style="background-color:#FBFBFB">10.152.152.10</span></i>, which is the Whonix-Gateway. Therefore, if for example you wish to tunnel Tor Browser via the route <code>User</code> -&gt; <code>Tor</code> -&gt; <code>Tunnel-link</code> -&gt; <code>Internet</code>, all proxy settings from <a data-href="/wiki/Tor_Browser" href="../Tor_Browser.html" title="Tor Browser">Tor Browser</a> need to be removed. See below for instructions.
</p><p><b>Deactivate uwt Wrappers</b><br/>
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p>The following instructions permanently deactivate all uwt wrappers and remove stream isolation for <a data-href="/wiki/Stream_Isolation#By_uwt_wrapper" href="../Stream_Isolation.html" title="Stream Isolation">uwt wrapped applications</a> system-wide. Consequently, all uwt wrapped applications revert to the default system networking configuration.
</p><p>If you want more granular control of uwt wrapper deactivation, see <a data-href="/wiki/Stream_Isolation#Deactivate_uwt_Stream_Isolation_Wrapper" href="../Stream_Isolation.html" title="Stream Isolation">Stream_Isolation#Deactivate_uwt_Stream_Isolation_Wrapper</a>.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p>Open <i><span style="background-color:#FBFBFB">/etc/uwt.d/50_user.conf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/uwt.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/uwt.d/50_user.conf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/uwt.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/uwt.d/50_user.conf</textarea>
</div>
</div>
</div>
<p>Add.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>uwtwrapper_global="0"</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">uwtwrapper_global="0"</textarea>
</div>
</div>
<p>Save and exit.
</p>
</div>
</div>
<hr/>
<p><b>Tor Browser Remove Proxy Settings</b><br/>
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><b>Introduction</b><br/>
</p><p>This configuration causes Tor Browser to no longer use proxy settings. With no proxy, Tor Browser uses the (VM) system's default networking. This is identical to any other application inside the Whonix-Workstation that has not been explicitly configured to use Tor via socks proxy settings or a socksifier. This setting is also called transparent torification. <sup class="reference" id="cite_ref-1"><a href="#cite_note-1">[1]</a></sup>
</p><p>Note: This action will break both the <a data-href="/wiki/Stream_Isolation" href="../Stream_Isolation.html" title="Stream Isolation">Stream Isolation</a> for Tor Browser and <a class="external text" data-href="https://trac.torproject.org/projects/tor/ticket/3455" href="https://trac.torproject.org/projects/tor/ticket/3455" rel="noreferrer noopener" target="_blank">Tor Browser's tab isolation by socks user name</a>. This worsens the <a data-href="/wiki/Fingerprint#web_fingerprint" href="../Fingerprint.html" title="Fingerprint">web fingerprint</a> and causes the user to be <a data-href="/wiki/DoNot#Do_not_confuse_Anonymity_with_Pseudonymity." href="../DoNot.html" title="DoNot">pseudonymous, rather than anonymous</a>. To mitigate these risks, consider using <a data-href="/wiki/Advanced_Security_Guide#More_than_one_Tor_Browser_in_Whonix" href="../Advanced_Security_Guide.html" title="Advanced Security Guide">More than one Tor Browser in Whonix</a>, or better yet, <a data-href="/wiki/Multiple_Whonix-Workstations" href="../Multiple_Whonix-Workstations.html" title="Multiple Whonix-Workstations">Multiple Whonix-Workstations</a>.
</p><p>If these settings are changed, expect Tor Button to show a red sign and state "Tor Disabled" if a mouse is hovered over it.
</p><p>To enable transparent torification (no proxy setting), set the <code>TOR_TRANSPROXY=1</code> environment variable. There are several methods, but the <a href="#.2Fetc.2Fenvironment_Method">#/etc/environment Method</a> is the simplest one.
</p>
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
<p>For other methods with finer granulated settings, please press on Expand on the right.
</p>
<div class="mw-collapsible-content">
<p>&lt;span id="<br/>od"&gt;
<b>Command Line Method</b><br/>
</p><p>Navigate to the Tor Browser folder.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>cd ~/tor-browser_en-US</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">cd ~/tor-browser_en-US</textarea>
</div>
</div>
<p>Every time Tor Browser is started, run the following command to set the <code>TOR_TRANSPROXY=1</code> environment variable.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>TOR_TRANSPROXY=1 ./start-tor-browser.desktop</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">TOR_TRANSPROXY=1 ./start-tor-browser.desktop</textarea>
</div>
</div>
<p><span id="start-tor-browser_Method"></span>
<b>start-tor-browser Method</b><br/>
</p><p>This only applies to a single instance of the Tor Browser folder that is configured. This method may not persist when Tor Browser is updated.
</p><p>Find and open <span style="border:1px dotted #005cb9">start-tor-browser</span> in the Tor Browser folder in an editor.
</p><p>This is most likely in <span style="border:1px dotted #005cb9">~/tor-browser_en-US/Browser/start-tor-browser</span> below <span style="border:1px dotted #005cb9">#!/usr/bin/env bash</span>.
</p><p>Set.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>export TOR_TRANSPROXY=1</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">export TOR_TRANSPROXY=1</textarea>
</div>
</div>
</div>
</div>
<p><span id=".2Fetc.2Fenvironment_Method"></span>
<b>/etc/environment Method</b><br/>
</p><p>This will apply to the whole environment, including any possible custom locations of Tor Browser installation folders. <sup class="reference" id="cite_ref-2"><a href="#cite_note-2">[2]</a></sup>
</p><p>Open <i><span style="background-color:#FBFBFB">/etc/environment</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/environment</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/environment</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/environment</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/environment</textarea>
</div>
</div>
</div>
<p>Add the following line.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>TOR_TRANSPROXY=1</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">TOR_TRANSPROXY=1</textarea>
</div>
</div>
<p>Save and reboot.
</p><p><b>Undo</b><br/>
</p><p>Reverting this change is undocumented. Simply unsetting that environment variable will not work due to Tor Browser limitations. The easiest way to undo this setting is to install a fresh instance of Tor Browser (please contribute to these instructions)!
</p><p><span id="Forget_about_Tor_Button.27s_Open_Network_Settings"></span>
<b>Ignore Tor Button's Open Network Settings</b><br/>
</p><p>Whonix has disabled the <code>Open Network Settings...</code> menu option in Tor Button. Read the footnote for further information. <sup class="reference" id="cite_ref-3"><a href="#cite_note-3">[3]</a></sup>
</p>
</div>
<hr/>
<p><b>Deactivate Miscellaneous Proxy Settings</b><br/>
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p>On the <a data-href="/wiki/Stream_Isolation" href="../Stream_Isolation.html" title="Stream Isolation">Stream Isolation</a> page, there is a list of applications that are pre-configured to use <a data-href="/wiki/Stream_Isolation#By_Settings" href="../Stream_Isolation.html" title="Stream Isolation">socks proxy settings</a> via application configuration files. To disable this, the Whonix system default must be removed from the application's settings.
</p><p>TODO: document and expand.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p>Remove proxy settings for <a data-href="/wiki/Tor_Browser#Tor_Browser_Downloader_by_Whonix" href="../Tor_Browser.html" title="Tor Browser">Tor Browser Downloader by Whonix</a>.
</p><p>Open <i><span style="background-color:#FBFBFB">/etc/torbrowser.d/50_user.conf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/torbrowser.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/torbrowser.d/50_user.conf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/torbrowser.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/torbrowser.d/50_user.conf</textarea>
</div>
</div>
</div>
<p>Paste. <sup class="reference" id="cite_ref-4"><a href="#cite_note-4">[4]</a></sup> <sup class="reference" id="cite_ref-5"><a href="#cite_note-5">[5]</a></sup>
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>TB_NO_TOR_CON_CHECK=1
CURL_PROXY="--fail"</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">TB_NO_TOR_CON_CHECK=1
CURL_PROXY="--fail"</textarea>
</div>
</div>
<p>Save.
</p>
</div>
<p>For some applications, this is impossible:
</p>
<ul><li><a data-href="/wiki/Sdwdate" href="../Sdwdate.html" title="Sdwdate">sdwdate</a></li>
<li>onionshare</li>
<li>Ricochet IM</li></ul>
<p><br/>
These applications can only talk to Tor <a data-href="/wiki/Onion_Services" href="../Onion_Services.html" title="Onion Services">Onion Services</a> directly and cannot be configured to use the system default. You can only deactivate sdwdate and/or not use Ricochet IM.
</p>
</div>
</div>
<p><span id="Fail_Closed_Mechanism"></span>
</p>
<h1><span class="mw-headline" id="Use_a_Fail_Closed_Mechanism">Use a Fail Closed Mechanism</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=3" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=3.html" title="Edit section: Use a Fail Closed Mechanism">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<p>A general problem with VPNs is that connections often fail to remain open. This means the VPN connection suddenly closes, leaving the user directly connected to the Internet (without first tunneling through the VPN). This is not a Whonix-specific problem. VPN servers and software can occasionally fail without prior notice. Therefore, if the VPN is unreachable or the connection breaks down for whatever reason, in most cases the user will continue to connect to the Internet without the VPN.
</p><p>One of the key benefits of Whonix is that when a VPN connection fails, protection is still provided by the Tor process. In this instance, the Whonix-Workstation will seamlessly continue to make "direct" connections through Tor. Failure of the VPN tunnel may be inconsequential if a VPN is only used to circumvent Tor censorship. On the other hand, if VPN use is intended to improve security, then it must be configured so that if/when the VPN connection fails, all connections between the outside world and the computer are halted.
</p><p>Instructions below include a fail closed mechanism.
</p>
<hr/>
<h1><span class="mw-headline" id="VPN_Client_Choice">VPN Client Choice</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=4" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=4.html" title="Edit section: VPN Client Choice">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<p>Use OpenVPN.
</p><p>Using bitmask for this use case is not possible. In other words, you cannot use <code>user -&gt; Tor -&gt; bitmask -&gt; Internet</code>. <sup class="reference" id="cite_ref-6"><a href="#cite_note-6">[6]</a></sup>
</p><p>Other VPN clients are <a data-href="/wiki/Unsupported" href="../Unsupported.html" title="Unsupported">unsupported</a>. We are not aware of any sane VPN client choices besides OpenVPN.
</p>
<hr/>
<h1><span id="Setup_Tor_before_a_VPN_(User_-&gt;_Tor_-&gt;_VPN_-&gt;_Internet)"></span><span class="mw-headline" id="Setup_Tor_before_a_VPN_.28User_-.3E_Tor_-.3E_VPN_-.3E_Internet.29">Setup Tor before a VPN (User -&gt; Tor -&gt; VPN -&gt; Internet)</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=5" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=5.html" title="Edit section: Setup Tor before a VPN (User -&gt; Tor -&gt; VPN -&gt; Internet)">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<h2><span class="mw-headline" id="Introduction">Introduction</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=6" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=6.html" title="Edit section: Introduction">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Two methods. 
</p>
<ul><li><a class="mw-redirect" data-href="/wiki/Qubes-Whonix" href="../Qubes-Whonix.html" title="Qubes-Whonix">Qubes-Whonix</a> users have the option to use a <a href="#Separate_VPN-Gateway">#Separate VPN-Gateway</a> but could also use <a href="#Inside_Whonix-Workstation">#Inside Whonix-Workstation</a>.</li>
<li><a data-href="/wiki/Non-Qubes-Whonix" href="../Non-Qubes-Whonix.html" title="Non-Qubes-Whonix">Non-Qubes-Whonix</a> users should prefer <a href="#Inside_Whonix-Workstation">#Inside Whonix-Workstation</a>.</li></ul>
<hr/>
<h2><span class="mw-headline" id="Separate_VPN-Gateway">Separate VPN-Gateway</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=7" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=7.html" title="Edit section: Separate VPN-Gateway">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>A separate VPN-Gateway between Whonix-Gateway and Whonix-Workstation, i.e. Whonix-Workstation -&gt; VPN-Gateway -&gt; Whonix-Gateway.
</p><p><a class="mw-redirect" data-href="/wiki/Qubes-Whonix" href="../Qubes-Whonix.html" title="Qubes-Whonix">Qubes-Whonix</a> only! <a data-href="/wiki/Non-Qubes-Whonix" href="../Non-Qubes-Whonix.html" title="Non-Qubes-Whonix">Non-Qubes-Whonix</a> is <a data-href="/wiki/Unsupported" href="../Unsupported.html" title="Unsupported">unsupported</a>!
</p><p><b>User -&gt; Tor -&gt; VPN -&gt; Internet</b>
</p><p>These "Separate VPN-Gateway" instructions are new. You might be one of the first users. You might run into minor issues. Please test and <a class="external text" data-href="https://forums.whonix.org/t/setup-a-vpn-in-proxyvm-over-sys-whonix" href="https://forums.whonix.org/t/setup-a-vpn-in-proxyvm-over-sys-whonix" rel="noreferrer noopener" target="_blank">report</a> how it went.
</p><p>Create a new ProxyVM called for example VPN-Gateway.
</p><p>Set the NetVM of the VPN-Gateway to Whonix-Gateway (commonly called <i><span style="background-color:#FBFBFB">sys-whonix</span></i>).
</p><p>Note that UDP-style VPN connections are incompatible with Tor; the VPN must be configured to use TCP. <sup class="reference" id="cite_ref-tor_no_udp_7-0"><a href="#cite_note-tor_no_udp-7">[7]</a></sup> To do that, add <code>proto tcp</code> to the VPN configuration file <i><span style="background-color:#FBFBFB">/rw/config/vpn/openvpn-client.ovpn</span></i>. Most, but not all VPN providers support this configuration.
</p><p>Setup the VPN-Gateway as per <a class="external text" data-href="https://www.qubes-os.org/doc/vpn/" href="https://www.qubes-os.org/doc/vpn/" rel="noreferrer noopener" target="_blank">Qubes VPN documentation</a> for ProxyVMs. It is also highly recommended to setup the iptables firewall rules as described in Qubes VPN documentation to prevent clearnet traffic when the VPN breaks down. (In that cases, Whonix-Workstation (commonly called <i><span style="background-color:#FBFBFB">anon-whonix</span></i> traffic would only go user -&gt; Tor -&gt; Internet as opposed to user -&gt; Tor -&gt; VPN -&gt; Internet, which is what you want if you are reading this documentation chapter.
</p><p>Check, that your VPN-Gateway is fully functional. Test connectivity from inside the VPN-Gateway.
</p><p>In Whonix-Workstation (commonly called <i><span style="background-color:#FBFBFB">anon-whonix</span></i>) you might want to apply instructions from above chapter <a href="#Prevent_Bypassing_the_Tunnel-Link">#Prevent Bypassing the Tunnel-Link</a>.
</p><p>No DNS configuration required. System DNS should work out of the box. <sup class="reference" id="cite_ref-8"><a href="#cite_note-8">[8]</a></sup>
</p><p>If you would use <a data-href="/wiki/Tor_Browser" href="../Tor_Browser.html" title="Tor Browser">Tor Browser</a>, it would show the following warning:
Something Went Wrong!<br/>
Tor is not working in this browser.<br/>
This is because Tor Browser can no longer access Tor's ControPort (<a class="mw-redirect" data-href="/wiki/Dev/CPFP" href="../Dev/CPFP.html" title="Dev/CPFP">control-port-filter-proxy-python</a>) on Whonix-Gateway.
</p><p>For troubleshooting, see footnote. <sup class="reference" id="cite_ref-9"><a href="#cite_note-9">[9]</a></sup>
</p><p>Done. It is recommended to run the related <a href="#Leak_Tests">#Leak Tests</a>.
</p><p>Whonix user forum discussion:<br/>
<a class="external free" data-href="https://forums.whonix.org/t/setup-a-vpn-in-proxyvm-over-sys-whonix" href="https://forums.whonix.org/t/setup-a-vpn-in-proxyvm-over-sys-whonix" rel="noreferrer noopener" target="_blank">https://forums.whonix.org/t/setup-a-vpn-in-proxyvm-over-sys-whonix</a>
</p><p><sup class="reference" id="cite_ref-10"><a href="#cite_note-10">[10]</a></sup>
</p>
<hr/>
<h2><span class="mw-headline" id="Inside_Whonix-Workstation">Inside Whonix-Workstation</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=8" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=8.html" title="Edit section: Inside Whonix-Workstation">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Connect to your VPN using your preferred software *inside* the (Whonix-)Workstation.
</p><p>Note that UDP-style VPN connections are incompatible with Tor; the VPN must be configured to use TCP. <sup class="reference" id="cite_ref-tor_no_udp_7-1"><a href="#cite_note-tor_no_udp-7">[7]</a></sup> To do that, add <code>proto tcp</code> to the VPN configuration file <i><span style="background-color:#FBFBFB">/etc/openvpn/openvpn.conf</span></i>. Most, but not all VPN providers support this configuration.
</p><p><b>User -&gt; Tor -&gt; VPN -&gt; Internet</b>
</p>
<h5><span class="mw-headline" id="Whonix_TUNNEL_FIREWALL_vs_standalone_VPN-Firewall">Whonix TUNNEL_FIREWALL vs standalone VPN-Firewall</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=9" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=9.html" title="Edit section: Whonix TUNNEL FIREWALL vs standalone VPN-Firewall">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>When applying VPN instructions inside Whonix VMs, <b>do not</b> use the standalone VPN-Firewall. It is not required and is incompatible with the integrated Whonix TUNNEL_FIREWALL feature which is documented below.
</p>
<h5><span class="mw-headline" id="Preparation">Preparation</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=10" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=10.html" title="Edit section: Preparation">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>It is challenging to set up OpenVPN on Whonix with a secure, leak preventing <a href="#Fail_Closed_Mechanism">Fail Closed Mechanism</a>. For this reason, it is strongly recommended to learn how to set up OpenVPN on Debian stable (currently stretch). The following steps are a simple overview of the process:
</p>
<ol><li>Prepare a Debian stable VM.</li>
<li>Install the Debian OpenVPN package: <i>sudo apt-get install openvpn</i></li>
<li>Research how to set up a VPN using OpenVPN on the command line. <sup class="reference" id="cite_ref-11"><a href="#cite_note-11">[11]</a></sup></li>
<li>Search for help with general VPN setup in the <a href="#VPN_Setup">#VPN Setup</a> chapter or on the <a class="mw-redirect" data-href="/wiki/TestVPN" href="../TestVPN.html" title="TestVPN">TestVPN</a> page. <a data-href="/wiki/Support" href="../Support.html" title="Support">Help</a> is available from various sources, and the VPN provider may also be of assistance.</li></ol>
<p>Whonix 12 users may recall the variable VPN_SERVERS; it has been abolished for better security. <sup class="reference" id="cite_ref-12"><a href="#cite_note-12">[12]</a></sup>
</p>
<h5><span class="mw-headline" id="Prerequisite_Knowledge">Prerequisite Knowledge</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=11" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=11.html" title="Edit section: Prerequisite Knowledge">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>Highly recommended reading and understanding before proceeding: <a data-href="/wiki/Whonix_Debian_Packages" href="../Whonix_Debian_Packages.html" title="Whonix Debian Packages">Whonix Debian Packages</a>
</p>
<h5><span class="mw-headline" id="Firewall_Settings">Firewall Settings</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=12" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=12.html" title="Edit section: Firewall Settings">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p><b>Modify Whonix-Workstation User Firewall Settings</b>
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><b>Note</b>: If no changes have yet been made to Whonix Firewall Settings, then the Whonix User Firewall Settings File <i><span style="background-color:#FBFBFB">/etc/whonix_firewall.d/50_user.conf</span></i> appears empty (because it does not exist). This is expected.
</p><p><u>If using <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, complete these steps.<br/>
In Whonix-Workstation AppVM.
</p><p>Make sure folder <i><span style="background-color:#FBFBFB">/rw/config/whonix_firewall.d</span></i> exists.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo mkdir -p /rw/config/whonix_firewall.d</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo mkdir -p /rw/config/whonix_firewall.d</textarea>
</div>
</div>
<p>Open <i><span style="background-color:#FBFBFB">/rw/config/whonix_firewall.d/50_user.conf</span></i> with root rights.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /rw/config/whonix_firewall.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /rw/config/whonix_firewall.d/50_user.conf</textarea>
</div>
</div>
<p><u>If using a graphical Whonix-Workstation</u>, complete these steps.
</p><p><code>Start Menu</code> -&gt; <code>Applications</code> -&gt; <code>Settings</code> -&gt; <code>User Firewall Settings</code>
</p><p><u>If using a terminal-only Whonix-Workstation</u>, complete these steps.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/whonix_firewall.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/whonix_firewall.d/50_user.conf</textarea>
</div>
</div>
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
<p>For more help, press on Expand on the right.
</p>
<div class="mw-collapsible-content">
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><b>Note</b>: The Whonix Global Firewall Settings File <i><span style="background-color:#FBFBFB">/etc/whonix_firewall.d/30_default.conf</span></i> contains default settings and explanatory comments about their purpose. By default, the file is opened read-only and is not meant to be directly edited. Below, it is recommended to open the file without root rights. The file contains an explanatory comment on how to change firewall settings.
</p>
<pre>## Please use "/etc/whonix_firewall.d/50_user.conf" for your custom configuration,
## which will override the defaults found here. When Whonix is updated, this
## file may be overwritten.
</pre>
<p>See also <a data-href="/wiki/Whonix_Configuration_Files" href="../Whonix_Configuration_Files.html" title="Whonix Configuration Files">Whonix modular flexible .d style configuration folders</a>.
</p><p>To view the file, follow these instructions.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If using <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, complete these steps.
</p><p><code>Qubes App Launcher (blue/grey "Q")</code> -&gt; <code>Template:</code> <code>whonix-ws-14</code> -&gt; <code>Whonix Global Firewall Settings</code>
</p><p><u>If using a graphical Whonix-Workstation</u>, complete these steps.
</p><p><code>Start Menu</code> -&gt; <code>Applications</code> -&gt; <code>Settings</code> -&gt; <code>Global Firewall Settings</code>
</p><p><u>If using a terminal-only Whonix-Workstation</u>, complete these steps.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>nano /etc/whonix_firewall.d/30_default.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">nano /etc/whonix_firewall.d/30_default.conf</textarea>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Add the following settings. You can skip comments (starting with <span style="border:1px dotted #005cb9">#</span>). Don't use <span style="border:1px dotted #005cb9">;</span> for comments. <sup class="reference" id="cite_ref-13"><a href="#cite_note-13">[13]</a></sup> Likely you do not need to either uncomment (removing the <span style="border:1px dotted #005cb9">#</span> in front) or modify <span style="border:1px dotted #005cb9">VPN_INTERFACE</span> / <span style="border:1px dotted #005cb9">LOCAL_NET</span>.
</p>
<pre>WORKSTATION_FIREWALL=1
TUNNEL_FIREWALL_ENABLE=true
</pre>
<p>Save.
</p>
<h5><span class="mw-headline" id="Reload_Firewall">Reload Firewall</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=13" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=13.html" title="Edit section: Reload Firewall">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p><b>Reload Whonix-Workstation Firewall.</b>
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, complete the following steps.
</p><p><code>Qubes App Launcher (blue/grey "Q")</code> -&gt; <code>Whonix-Workstation AppVM (commonly named anon-whonix)</code> -&gt; <code>Reload Whonix Firewall</code>
</p><p><u>If you are using a graphical Whonix-Workstation</u>, complete the following steps.
</p><p><code>Start Menu</code> -&gt; <code>Applications</code> -&gt; <code>System</code> -&gt; <code>Reload Whonix Firewall</code>
</p><p><u>If you are using a terminal-only Whonix-Workstation</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo whonix_firewall</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo whonix_firewall</textarea>
</div>
</div>
</div>
<h5><span class="mw-headline" id="sudoers_configuration">sudoers configuration</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=14" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=14.html" title="Edit section: sudoers configuration">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>Open <i><span style="background-color:#FBFBFB">/etc/sudoers.d/tunnel_unpriv</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/sudoers.d/tunnel_unpriv</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/sudoers.d/tunnel_unpriv</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/sudoers.d/tunnel_unpriv</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/sudoers.d/tunnel_unpriv</textarea>
</div>
</div>
</div>
<p>Comment in the following and remove the single hashes (<i><span style="background-color:#FBFBFB">#</span></i>) in front of all lines, but do not remove the double hashes (<i><span style="background-color:#FBFBFB">##</span></i>). The edited file should look like this.
</p>
<pre>tunnel ALL=(ALL) NOPASSWD: /bin/ip
tunnel ALL=(ALL) NOPASSWD: /usr/sbin/openvpn *
Defaults:tunnel !requiretty
</pre>
<p>Save and exit.
</p><p>Add.
</p>
<pre>Defaults:tunnel env_keep += script_type
Defaults:tunnel env_keep += dev
</pre>
<p>Save.
</p>
<h5><span class="mw-headline" id="VPN_Setup">VPN Setup</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=15" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=15.html" title="Edit section: VPN Setup">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<h6><span class="mw-headline" id="Introduction_2">Introduction</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=16" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=16.html" title="Edit section: Introduction">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>The following example uses the free Riseup VPN, because it is known to support TCP, UDP and SSL. However, any preferred VPN can be used.
</p><p>Update: The Riseup "legacy" VPN may have been discontinued, as it no longer works for the author of these instructions. The Riseup replacement service (Bitmask) has not been tested.
</p>
<h6><span class="mw-headline" id="Get_VPN_Certificate">Get VPN Certificate</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=17" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=17.html" title="Edit section: Get VPN Certificate">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>Look at the <a class="external text" data-href="https://help.riseup.net/vpn" href="https://help.riseup.net/vpn" rel="noreferrer noopener" target="_blank">riseup VPN help page</a> for <a class="external text" data-href="https://help.riseup.net/en/riseup-ca" href="https://help.riseup.net/en/riseup-ca" rel="noreferrer noopener" target="_blank"><code>RiseupCA.pem</code></a> and (right-click) <a class="external text" data-href="https://help.riseup.net/security/network-security/riseup-ca/RiseupCA.pem" href="https://help.riseup.net/security/network-security/riseup-ca/RiseupCA.pem" rel="noreferrer noopener" target="_blank">download</a> it. Store the certificate in <i><span style="background-color:#FBFBFB">/etc/openvpn/RiseupCA.pem</span></i>
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>curl --tlsv1.2 --proto =https https://help.riseup.net/security/network-security/riseup-ca/RiseupCA.pem | sudo tee /etc/openvpn/RiseupCA.pem</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">curl --tlsv1.2 --proto =https https://help.riseup.net/security/network-security/riseup-ca/RiseupCA.pem | sudo tee /etc/openvpn/RiseupCA.pem</textarea>
</div>
</div>
<h6><span class="mw-headline" id="VPN_Credentials">VPN Credentials</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=18" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=18.html" title="Edit section: VPN Credentials">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>For this step, a riseup.net account and Riseup account name is required. Go to <a class="external free" data-href="https://user.riseup.net/users/riseupusername/vpn" href="https://user.riseup.net/users/riseupusername/vpn" rel="noreferrer noopener" target="_blank">https://user.riseup.net/users/riseupusername/vpn</a> to obtain a VPN secret (VPN password). Below, replace "riseupusername" with the actual riseup user name, or just go to <a class="external free" data-href="https://user.riseup.net" href="https://user.riseup.net" rel="noreferrer noopener" target="_blank">https://user.riseup.net</a>, login and click on "VPN". 
</p><p>Open <i><span style="background-color:#FBFBFB">/etc/openvpn/auth.txt</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/openvpn/auth.txt</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/openvpn/auth.txt</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/openvpn/auth.txt</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/openvpn/auth.txt</textarea>
</div>
</div>
</div>
<p>Add the <i>actual</i> user name and password.
</p>
<pre>riseupusername
vpnsecret
</pre>
<p>Save and exit.
</p>
<h6><span class="mw-headline" id="VPN_IP_Address">VPN IP Address</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=19" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=19.html" title="Edit section: VPN IP Address">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>Note: IP addresses are required, not DNS hostnames. Therefore, <i><span style="background-color:#FBFBFB">vpn.riseup.net</span></i> cannot be used, but an IP address instead like <i><span style="background-color:#FBFBFB">198.252.153.226</span></i>. To discover the IP address, check with the provider or use nslookup on the host. For example, to verify the actual IP address of the <i><span style="background-color:#FBFBFB">vpn.riseup.net</span></i> DNS server, run.
</p>
<pre>nslookup vpn.riseup.net
</pre>
<h6><span class="mw-headline" id="VPN_Configuration_File">VPN Configuration File</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=20" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=20.html" title="Edit section: VPN Configuration File">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>Open <i><span style="background-color:#FBFBFB">/etc/openvpn/openvpn.conf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/openvpn/openvpn.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/openvpn/openvpn.conf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/openvpn/openvpn.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/openvpn/openvpn.conf</textarea>
</div>
</div>
</div>
<p>Add.
</p><p>Note: make sure to adjust the <span style="border:1px dotted #005cb9">remote 198.252.153.226 80</span> variable in your config (unless you are using <span style="border:1px dotted #005cb9">nyc.vpn.riseup.net</span> as your VPN service). Replace the IP (<span style="border:1px dotted #005cb9">198.252.153.226</span>) and port (<span style="border:1px dotted #005cb9">80</span>) to match your VPN service.
</p>
<pre>##############################
## VPN provider specific settings ##
##############################
auth-user-pass auth.txt

## using nyc.vpn.riseup.net 80
remote 198.252.153.226 80

ca RiseupCA.pem

remote-cert-tls server

####################################
## TUNNEL_FIREWALL specific settings ##
####################################
client
dev tun0
persist-tun
persist-key

script-security 2
up "/etc/openvpn/update-resolv-conf script_type=up dev=tun0"
down "/etc/openvpn/update-resolv-conf script_type=down dev=tun0"

user tunnel
iproute /usr/bin/ip_unpriv

############################################
## Connecting to Tor before a VPN specific settings #
############################################

proto tcp
</pre>
<p><sup class="reference" id="cite_ref-14"><a href="#cite_note-14">[14]</a></sup> <sup class="reference" id="cite_ref-15"><a href="#cite_note-15">[15]</a></sup>
</p><p>Save.
</p>
<h6><span class="mw-headline" id="install_resolvconf">install resolvconf</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=21" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=21.html" title="Edit section: install resolvconf">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p><a class="mw-redirect" data-href="/wiki/Update" href="../Update.html" title="Update">Update</a> the package lists.
</p>
<pre>sudo apt-get update
</pre>
<p>Install resolvconf. <sup class="reference" id="cite_ref-16"><a href="#cite_note-16">[16]</a></sup>
</p>
<pre>sudo apt-get install resolvconf
</pre>
<p>Users preferring not to install resolvconf should read the footnotes. <sup class="reference" id="cite_ref-17"><a href="#cite_note-17">[17]</a></sup>
</p><p>This will remove several Whonix meta packages. To find out what that is about and what the following command is good for, please read the prerequisite knowledge wiki page <a data-href="/wiki/Whonix_Debian_Packages" href="../Whonix_Debian_Packages.html" title="Whonix Debian Packages">Whonix Debian Packages</a>.
</p>
<pre>sudo aptitude keep-all
</pre>
<p>Next time you run <a data-href="/wiki/Whonixcheck" href="../Whonixcheck.html" title="Whonixcheck">whonixcheck</a> you will get the following warning.
</p><p><code>Whonix Meta Packages test Result: Whonix-Workstation detected that the meta package (non-)qubes-whonix-workstation is not installed</code>
</p><p>The background of this is also explained on the wiki page <a data-href="/wiki/Whonix_Debian_Packages" href="../Whonix_Debian_Packages.html" title="Whonix Debian Packages">Whonix Debian Packages</a>.
</p>
<h6><span class="mw-headline" id="DNS_Configuration">DNS Configuration</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=22" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=22.html" title="Edit section: DNS Configuration">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>Open <i><span style="background-color:#FBFBFB">/usr/lib/tmpfiles.d/50_openvpn_unpriv.conf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /usr/lib/tmpfiles.d/50_openvpn_unpriv.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /usr/lib/tmpfiles.d/50_openvpn_unpriv.conf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /usr/lib/tmpfiles.d/50_openvpn_unpriv.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /usr/lib/tmpfiles.d/50_openvpn_unpriv.conf</textarea>
</div>
</div>
</div>
<p>Add. <sup class="reference" id="cite_ref-Whonix14_18-0"><a href="#cite_note-Whonix14-18">[18]</a></sup>
</p>
<pre>d       /run/resolvconf 0775    root      tunnel    -       -
d       /run/resolvconf/interface         0775      root    tunnel    -    -
</pre>
<p>Save.
</p><p>Adjust permissions. <sup class="reference" id="cite_ref-Whonix14_18-1"><a href="#cite_note-Whonix14-18">[18]</a></sup>
</p>
<pre>sudo chown --recursive root:tunnel /run/resolvconf
</pre>
<pre>sudo chmod --recursive 775 /run/resolvconf
</pre>
<p>Open <i><span style="background-color:#FBFBFB">/etc/resolvconf/run/interface/original.resolvconf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/resolvconf/run/interface/original.resolvconf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/resolvconf/run/interface/original.resolvconf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/resolvconf/run/interface/original.resolvconf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/resolvconf/run/interface/original.resolvconf</textarea>
</div>
</div>
</div>
<p>Comment everything out by adding a <i>#</i> in front of all entries. Alternatively, empty or delete that file. <sup class="reference" id="cite_ref-19"><a href="#cite_note-19">[19]</a></sup>
</p><p>Save and exit.
</p>
<h4><span class="mw-headline" id="Setup">Setup</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=23" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=23.html" title="Edit section: Setup">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<h6><span class="mw-headline" id="Configuration_Folder_Permissions">Configuration Folder Permissions</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=24" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=24.html" title="Edit section: Configuration Folder Permissions">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>Since OpenVPN will be run under user <i>tunnel</i>, that user requires read access to the folder <i>/etc/openvpn</i>.
</p>
<pre>sudo chown -R tunnel:tunnel /etc/openvpn
</pre>
<pre>sudo chown -R tunnel:tunnel /var/run/openvpn
</pre>
<h5><span class="mw-headline" id="systemd_setup">systemd setup</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=25" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=25.html" title="Edit section: systemd setup">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>Create the OpenVPN systemd service file.
</p>
<pre>sudo cp /lib/systemd/system/openvpn@.service /lib/systemd/system/openvpn@openvpn.service
</pre>
<p>Enable the OpenVPN systemd service file.
</p>
<pre>sudo systemctl enable openvpn@openvpn
</pre>
<p>Start the OpenVPN systemd service.
</p>
<pre>sudo systemctl start openvpn@openvpn
</pre>
<p>Check the OpenVPN systemd service status.
</p>
<pre>sudo systemctl status openvpn@openvpn
</pre>
<h5><span class="mw-headline" id="resolvconf_adjustments">resolvconf adjustments</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=26" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=26.html" title="Edit section: resolvconf adjustments">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>Restart resolvconf. <sup class="reference" id="cite_ref-20"><a href="#cite_note-20">[20]</a></sup>
</p>
<pre>sudo service resolvconf restart
</pre>
<h5><span class="mw-headline" id="Verify_DNS_Settings">Verify DNS Settings</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=27" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=27.html" title="Edit section: Verify DNS Settings">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>See current /etc/resolv.conf settings.
</p>
<pre>sudo cat /etc/resolv.conf
</pre>
<p>Should not include the following settings.<sup class="reference" id="cite_ref-21"><a href="#cite_note-21">[21]</a></sup>
</p>
<pre>nameserver 10.152.152.10
</pre>
<p>Should not include the following settings.<sup class="reference" id="cite_ref-22"><a href="#cite_note-22">[22]</a></sup>
</p>
<pre>nameserver 10.137.3.1
nameserver 10.137.3.254
</pre>
<p>Should include only the DNS server of your DNS provider. For example.
</p>
<pre>nameserver 10.5.0.1
</pre>
<h5><span class="mw-headline" id="whonixcheck">whonixcheck</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=28" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=28.html" title="Edit section: whonixcheck">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>whonixcheck cannot work in this configuration out of the box. To unbreak it.
</p><p>Open <i><span style="background-color:#FBFBFB">/etc/whonix.d/50_user.conf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/whonix.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/whonix.d/50_user.conf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/whonix.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/whonix.d/50_user.conf</textarea>
</div>
</div>
</div>
<pre>whonixcheck_skip_functions+=" check_tor_bootstrap "
whonixcheck_skip_functions+=" check_tor_socks_port_reachability "
whonixcheck_skip_functions+=" check_tor_socks_port "
whonixcheck_skip_functions+=" check_tor_trans_port "
whonixcheck_skip_functions+=" check_stream_isolation "
whonixcheck_skip_functions+=" download_whonix_news "

## {{ Alternative to disabling check_tor_trans_port.

## Make the Tor TransPort test work by simulating the Tor SocksPort test succeeded.
#CHECK_TOR_RESULT_SOCKS_PORT=0

## Do not warn if Tor was not detected. (Will be the VPN.)
#WHONIXCHECK_NO_EXIT_ON_TRANS_PORT_DETECTION_FAILURE=1

## }}

## {{ Alternative to download_whonix_news.

## Download news through system default.
#CURL_PROXY_WHONIX_NEWS="--fail"

## }}
</pre>
<p>Save.
</p>
<h5><span class="mw-headline" id="Qubes_specific">Qubes specific</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=29" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=29.html" title="Edit section: Qubes specific">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<div class="toccolours mw-collapsible mw-collapsed" style="width:800px">
<p>Placeholder. Ignore the Qubes specific chapter for now. TODO
</p>
<div class="mw-collapsible-content">
<p>When using a TemplateBasedVM, to persist these changes use the Qubes bind dirs mechanism.
</p>
<pre>sudo mkdir /rw/config/qubes-bind-dirs.d
</pre>
<p>Open <i><span style="background-color:#FBFBFB">/rw/config/qubes-bind-dirs.d/50_user.conf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /rw/config/qubes-bind-dirs.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /rw/config/qubes-bind-dirs.d/50_user.conf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /rw/config/qubes-bind-dirs.d/50_user.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /rw/config/qubes-bind-dirs.d/50_user.conf</textarea>
</div>
</div>
</div>
<pre>binds+=( '/etc/sudoers.d/tunnel_unpriv' )
binds+=( '/etc/openvpn' )
binds+=( '/lib/systemd/system/openvpn@openvpn.service' )
binds+=( '/etc/systemd/system/multi-user.target.wants/openvpn@openvpn.service' )
</pre>
<p>TODO: Does not work yet. Files need to exist first.
</p>
<pre>/usr/lib/qubes/bind-dirs.sh umount
</pre>
<pre>/usr/lib/qubes/bind-dirs.sh
</pre>
</div>
</div>
<h5><span class="mw-headline" id="Test">Test</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=30" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=30.html" title="Edit section: Test">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>Test ping to IP. Ping some IP. Ping google's DNS server or maybe better some server of your choice.
</p>
<pre>ping 8.8.8.8
</pre>
<p>Test DNS. DNS resolve some domain. Resolve check.torproject.org or maybe better some server of your choice.
</p>
<pre>nslookup check.torproject.org
</pre>
<p>Test DNS and output IP address.
</p>
<pre>whonixcheck_skip_functions="" \
CHECK_TOR_RESULT_SOCKS_PORT=0 \
WHONIXCHECK_NO_EXIT_ON_TRANS_PORT_DETECTION_FAILURE=1 \
whonixcheck --function check_tor_trans_port
</pre>
<h5><span class="mw-headline" id="Done">Done</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=31" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=31.html" title="Edit section: Done">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>Done. If you have any issues, see below chapter <a href="#Troubleshooting">#Troubleshooting</a>. Once it is working, it is recommended to run the <a href="#Leak_Tests">#Leak Tests</a>.
</p>
<h5><span class="mw-headline" id="Troubleshooting">Troubleshooting</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=32" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=32.html" title="Edit section: Troubleshooting">edit</a><span class="mw-editsection-bracket">]</span></span></h5>
<p>You can skip this troubleshooting chapter unless any difficulties are encountered.
</p>
<h6><span class="mw-headline" id="ip_unpriv_vs_ip-unpriv">ip_unpriv vs  ip-unpriv</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-1" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-1.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>There are two similar, yet distinct projects: standalone VPN-FIREWALL and Whonix TUNNEL_FIREWALL. Although both are alike, there is one difference that might be encountered. For instance, in chapter <a href="#VPN_Configuration_File">#VPN Configuration File</a>:
</p>
<ul><li>Whonix TUNNEL_FIREWALL uses <i><span style="background-color:#FBFBFB">ip<b>_</b>unpriv</span></i> (underscore)</li>
<li>Standalone VPN-FIREWALL uses <i><span style="background-color:#FBFBFB">ip<b>-</b>unpriv</span></i> (hyphen)</li></ul>
<p><br/>
Be sure to use the right version of ip unpriv according to whether the VPN-FIREWALL or Whonix TUNNEL_FIREWALL project is being used.
</p>
<h6><span class="mw-headline" id="50_openvpn_unpriv.conf_vs_50_openvpn-unpriv.conf">50_openvpn_unpriv.conf vs 50_openvpn-unpriv.conf</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-2" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-2.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>Like the example above:
</p>
<ul><li>Whonix TUNNEL_FIREWALL uses /usr/lib/tmpfiles.d/50_openvpn_unpriv.conf <i><span style="background-color:#FBFBFB">ip<b>_</b>unpriv</span></i> (underscore)</li>
<li>Standalone VPN-FIREWALL uses  /usr/lib/tmpfiles.d/50_openvpn-unpriv.conf <i><span style="background-color:#FBFBFB">ip<b>-</b>unpriv</span></i> (hyphen)</li></ul>
<h6><span class="mw-headline" id="Cannot_ioctl_TUNSETIFF">Cannot ioctl TUNSETIFF</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-3" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-3.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<pre>ERROR: Cannot ioctl TUNSETIFF tun: Operation not permitted (errno=1)
</pre>
<p>In openvpn.conf do not use.
</p>
<pre>dev tun
</pre>
<p>Use.
</p>
<pre>dev tun0
</pre>
<h6><span class="mw-headline" id="Dev_tun_Mismatch">Dev tun Mismatch</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-4" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-4.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>In openvpn.conf do not use.
</p>
<pre>dev tun
</pre>
<p>Use.
</p>
<pre>dev tun0
</pre>
<h6><span id="/run/openvpn/openvpn.status_Permission_denied"></span><span class="mw-headline" id=".2Frun.2Fopenvpn.2Fopenvpn.status_Permission_denied">/run/openvpn/openvpn.status Permission denied</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-5" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-5.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<pre>Options error: --status fails with '/run/openvpn/openvpn.status': Permission denied
</pre>
<p>Do not start OpenVPN as root. Do not use <i>sudo openvpn</i>, because this will lead to permission issues. Files in the <i>/run/openvpn</i> folder are owned by root, so they cannot be overwritten by the user tunnel.
</p>
<h6><span class="mw-headline" id="debug_start">debug start</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-6" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-6.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>To debug start on the command line, run.
</p>
<pre>sudo /usr/sbin/openvpn --rmtun --dev tun0
sudo /usr/sbin/openvpn --mktun --dev tun0 --dev-type tun --user tunnel --group tunnel
cd /etc/openvpn/
sudo -u tunnel openvpn /etc/openvpn/openvpn.conf
</pre>
<h6><span class="mw-headline" id="Linux_ip_link_set_failed">Linux ip link set failed</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-7" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-7.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<pre>Linux ip link set failed: external program exited with error status: 2
</pre>
<p>Use ip_unpriv as documented above.
</p>
<h6><span class="mw-headline" id="DNS_Configuration_2">DNS Configuration</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-8" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-8.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>This only applies if resolvconf is used.
</p><p>Permissions on two directories may need to be manually changed if they are not automatically applied. Check if changes are necessary via the following command.
</p>
<pre>ls -al /run/resolvconf
</pre>
<p>If the output lists tunnel as having read / write / execute permissions for both <i>/run/resolvconf</i> and <i>/run/resolvconf/interface</i>, then nothing needs modification. If tunnel is not listed as a group for one or both of these directories, then permissions need to be changed. In that case, run.
</p>
<pre>sudo chown --recursive root:tunnel /run/resolvconf
</pre>
<p>Then set the necessary permissions.
</p>
<pre>sudo chmod --recursive 775 /run/resolvconf
</pre>
<p>In <i>/run/resolvconf</i>, resolv.conf may or may not be owned by tunnel, depending on whether the systemd service has already started. There is no need to modify permissions on this file, as the permissions will change when the service starts.
</p>
<h6><span class="mw-headline" id="Terminology_for_Support_Requests">Terminology for Support Requests</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-9" href="https://www.whonix.org/w/index.php?title=Template:VPN-Firewall/Troubleshooting&amp;action=edit&amp;section=T-9.html" title="Edit section: ">edit</a><span class="mw-editsection-bracket">]</span></span></h6>
<p>Phrases such as "over Tor" are ambiguous. Please do not coin idiosyncratic words or phrases, otherwise this leads to confusion. Please use the same terms that are consistently referenced in documentation, such as:
</p>
<ul><li>How to Connect to a VPN Before Tor (User -&gt; VPN -&gt; Tor -&gt; Internet).</li>
<li>How to Connect to Tor Before a VPN (User -&gt; Tor -&gt; VPN -&gt; Internet).</li>
<li>And so on.</li></ul>
<p><br/>
Always refer to the connection scheme when requesting support: <i><span style="background-color:#FBFBFB">User -&gt; VPN -&gt; Tor -&gt; Internet</span></i> or <i><span style="background-color:#FBFBFB">User -&gt; Tor -&gt; VPN -&gt; Internet</span></i> and so on.
</p>
<hr/>
<h1><span class="mw-headline" id="Leak_Tests">Leak Tests</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=33" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=33.html" title="Edit section: Leak Tests">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<h2><span class="mw-headline" id="Introduction_3">Introduction</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=34" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=34.html" title="Edit section: Introduction">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>We want to verify, that the traffic always goes <i><span style="background-color:#FBFBFB">User -&gt; Tor -&gt; VPN -&gt; Internet</span></i> and not only <i><span style="background-color:#FBFBFB">User -&gt; Tor -&gt; Internet</span></i>. Therefore you should run the following related leak tests inside Whonix-Workstation. Test Tor Browser, a uwt wrapper deactivated application as well as a regular application for leaks.
</p>
<h2><span class="mw-headline" id="regular_application_test">regular application test</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=35" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=35.html" title="Edit section: regular application test">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Same test as above, but use curl without pre-configured <a data-href="/wiki/Stream_Isolation" href="../Stream_Isolation.html" title="Stream Isolation">stream isolation</a>.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>UWT_DEV_PASSTHROUGH=1 curl --silent --tlsv1.2 --proto =https https://check.torproject.org | grep IP</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">UWT_DEV_PASSTHROUGH=1 curl --silent --tlsv1.2 --proto =https https://check.torproject.org | grep IP</textarea>
</div>
</div>
<p><sup class="reference" id="cite_ref-nodns_23-0"><a href="#cite_note-nodns-23">[23]</a></sup> <sup class="reference" id="cite_ref-24"><a href="#cite_note-24">[24]</a></sup>
</p><p>Should show something along the lines: <i><span style="background-color:#FBFBFB">Your IP address appears to be: xxx.xxx.xxx.xxx</span></i><br/>
Should show the IP of your VPN.
</p>
<h2><span class="mw-headline" id="uwt_wrapped_application_test">uwt wrapped application test</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=36" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=36.html" title="Edit section: uwt wrapped application test">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>Connect to check.torproject.org.
</p><p></p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>curl --silent --tlsv1.2 --proto =https https://check.torproject.org | grep IP</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">curl --silent --tlsv1.2 --proto =https https://check.torproject.org | grep IP</textarea>
</div>
</div>
<p><sup class="reference" id="cite_ref-nodns_23-1"><a href="#cite_note-nodns-23">[23]</a></sup> <sup class="reference" id="cite_ref-25"><a href="#cite_note-25">[25]</a></sup>
</p>
<h2><span class="mw-headline" id="Browser_IP_Test">Browser IP Test</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=37" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=37.html" title="Edit section: Browser IP Test">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>You can skip this test if you do not care about using Tor Browser through the VPN.
</p><p>If you did correctly configure everything, test your setup. Open <a class="external free" data-href="https://check.torproject.org" href="https://check.torproject.org" rel="noreferrer noopener" target="_blank">https://check.torproject.org</a> in Tor Browser. It will tell you then "<i><span style="background-color:#FBFBFB">You are not using Tor.</span></i>" and you'll see your VPN's IP. In fact your VPN was tunneled through Tor first. (Because Whonix-Workstation can not make any non-Tor connections by design, everything is tunneled over Tor.)
</p>
<h2><span class="mw-headline" id="DNS_Leak_Test">DNS Leak Test</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=38" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=38.html" title="Edit section: DNS Leak Test">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<ul><li><a class="external free" data-href="http://www.dnsleaktest.com/" href="http://www.dnsleaktest.com/" rel="noreferrer noopener" target="_blank">http://www.dnsleaktest.com/</a></li>
<li><a class="external free" data-href="http://dnsleak.com/" href="http://dnsleak.com/" rel="noreferrer noopener" target="_blank">http://dnsleak.com/</a></li>
<li><a class="external free" data-href="https://dns-leak.com/" href="https://dns-leak.com/" rel="noreferrer noopener" target="_blank">https://dns-leak.com/</a></li>
<li><a class="external free" data-href="http://check2ip.com/" href="http://check2ip.com/" rel="noreferrer noopener" target="_blank">http://check2ip.com/</a></li></ul>
<h2><span class="mw-headline" id="Other_Leak_Tests">Other Leak Tests</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=39" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=39.html" title="Edit section: Other Leak Tests">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>If you are feeling awesome, you could also run more general leak tests that are not related to tunneling. However, these are more difficult to do and target developers rather than users. If you are interested, see <a data-href="/wiki/Dev/Leak_Tests" href="../Dev/Leak_Tests.html" title="Dev/Leak Tests">leak tests</a>.
</p>
<hr/>
<h1><span class="mw-headline" id="Footnotes">Footnotes</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=40" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit&amp;section=40.html" title="Edit section: Footnotes">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<div class="reflist" style="list-style-type: decimal;">
<div class="mw-references-wrap mw-references-columns"><ol class="references">
<li id="cite_note-1"><span class="mw-cite-backlink"><a href="#cite_ref-1">↑</a></span> <span class="reference-text">
This term was coined in context of a <a class="external text" data-href="https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy" href="https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy" rel="noreferrer noopener" target="_blank">Tor Transparent Proxy</a>. It acts as a simple gateway that routes all connections through Tor, but does not provide <a data-href="/wiki/Stream_Isolation" href="../Stream_Isolation.html" title="Stream Isolation">Stream Isolation</a>.</span>
</li>
<li id="cite_note-2"><span class="mw-cite-backlink"><a href="#cite_ref-2">↑</a></span> <span class="reference-text">Unless this environment variable is manually unset before starting Tor Browser.</span>
</li>
<li id="cite_note-3"><span class="mw-cite-backlink"><a href="#cite_ref-3">↑</a></span> <span class="reference-text">The regular Tor Browser Bundle from The Tor Project (without Whonix) allows networking settings to changed inside Tor via the <code>Open Network Settings</code> menu option. It has the same effect as editing Tor's config file torrc. In Whonix, the environment variable <code>export TOR_NO_DISPLAY_NETWORK_SETTINGS=1</code> has been <a class="external text" data-href="https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/torbrowser.sh" href="https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/torbrowser.sh" rel="noreferrer noopener" target="_blank">set</a> to disable the <code>TorButton</code> -&gt; <code>Open Network Settings...</code> menu item. It is not useful and confusing to have in the Whonix-Workstation because:
<ul><li>In Whonix, there is only limited access to Tor's control port (see <a class="mw-redirect" data-href="/wiki/Dev/CPFP" href="../Dev/CPFP.html" title="Dev/CPFP">Dev/CPFP</a> for more information).</li>
<li>For security reasons, Tor must be manually configured in <i>/usr/local/etc/torrc.d/50_user.conf</i> on the Whonix-Gateway, and not from the Whonix-Workstation (see <a data-href="/wiki/Features#VPN_.2F_Tunnel_support" href="../Features.html" title="Features">VPN/Tunnel support</a> for more information). </li></ul>
</span></li>
<li id="cite_note-4"><span class="mw-cite-backlink"><a href="#cite_ref-4">↑</a></span> <span class="reference-text">
<code>TB_NO_TOR_CON_CHECK=1</code> needs to be set because there is no filtered Tor ControlPort access when Whonix tunnel firewall is enabled, which would break tb-updater's Tor connectivity check.</span>
</li>
<li id="cite_note-5"><span class="mw-cite-backlink"><a href="#cite_ref-5">↑</a></span> <span class="reference-text">
By tb-updater default, if unset, variable <code>CURL_PROXY</code> will be dynamically set to a Tor SocksPort on Whonix-Gateway. For example to <code>CURL_PROXY="--proxy socks5h://user:password@10.137.6.1:9115"</code>.
<br/>
By using a curl parameter we are using anyhow, i.e. <code>CURL_PROXY="--fail"</code> we can in effect disable the environment variable even if it's technically still set. This will result in downloading by using the system's default networking.</span>
</li>
<li id="cite_note-6"><span class="mw-cite-backlink"><a href="#cite_ref-6">↑</a></span> <span class="reference-text">
<a class="external free" data-href="https://github.com/leapcode/bitmask_client/issues/1009" href="https://github.com/leapcode/bitmask_client/issues/1009" rel="noreferrer noopener" target="_blank">https://github.com/leapcode/bitmask_client/issues/1009</a></span>
</li>
<li id="cite_note-tor_no_udp-7"><span class="mw-cite-backlink">↑ <sup><a href="#cite_ref-tor_no_udp_7-0">7.0</a></sup> <sup><a href="#cite_ref-tor_no_udp_7-1">7.1</a></sup></span> <span class="reference-text">
<a data-href="/wiki/Tor#UDP" href="../Tor.html" title="Tor">Tor#UDP</a></span>
</li>
<li id="cite_note-8"><span class="mw-cite-backlink"><a href="#cite_ref-8">↑</a></span> <span class="reference-text">
Because a properly configured Qubes VPN-Gateway will be able to resolve DNS.</span>
</li>
<li id="cite_note-9"><span class="mw-cite-backlink"><a href="#cite_ref-9">↑</a></span> <span class="reference-text">
<ul><li>Check, that your VPN-Gateway is fully functional. Test connectivity from inside the VPN-Gateway.</li>
<li>Add a non-Whonix VM behind your VPN-Gateway. For example, add a debian based AppVM behind your VPN-Gateway. Figure out if the VPN-Gateway works at all before involving Whonix.</li></ul>
</span></li>
<li id="cite_note-10"><span class="mw-cite-backlink"><a href="#cite_ref-10">↑</a></span> <span class="reference-text">
<ul><li>Qubes users mailing list discussion: <a class="external free" data-href="https://groups.google.com/d/msgid/qubes-users/5759D76E.8000401%40riseup.net" href="https://groups.google.com/d/msgid/qubes-users/5759D76E.8000401%40riseup.net" rel="noreferrer noopener" target="_blank">https://groups.google.com/d/msgid/qubes-users/5759D76E.8000401%40riseup.net</a></li>
<li>Qubes development ticket: <a class="external free" data-href="https://github.com/QubesOS/qubes-issues/issues/2060" href="https://github.com/QubesOS/qubes-issues/issues/2060" rel="noreferrer noopener" target="_blank">https://github.com/QubesOS/qubes-issues/issues/2060</a></li></ul>
</span></li>
<li id="cite_note-11"><span class="mw-cite-backlink"><a href="#cite_ref-11">↑</a></span> <span class="reference-text">Only proceed if this is successful. Do not post support requests regarding these instructions before completing this basic exercise.</span>
</li>
<li id="cite_note-12"><span class="mw-cite-backlink"><a href="#cite_ref-12">↑</a></span> <span class="reference-text"><a class="external free" data-href="https://phabricator.whonix.org/T460" href="https://phabricator.whonix.org/T460" rel="noreferrer noopener" target="_blank">https://phabricator.whonix.org/T460</a></span>
</li>
<li id="cite_note-13"><span class="mw-cite-backlink"><a href="#cite_ref-13">↑</a></span> <span class="reference-text">That config file is a bash fragment.</span>
</li>
<li id="cite_note-14"><span class="mw-cite-backlink"><a href="#cite_ref-14">↑</a></span> <span class="reference-text">
The <a class="external text" data-href="https://github.com/Whonix/usability-misc/blob/master/usr/bin/ip_unpriv" href="https://github.com/Whonix/usability-misc/blob/master/usr/bin/ip_unpriv" rel="noreferrer noopener" target="_blank">/usr/bin/ip_unpriv</a> wrapper script is being provided by the <a class="external text" data-href="https://github.com/Whonix/usability-misc" href="https://github.com/Whonix/usability-misc" rel="noreferrer noopener" target="_blank">usabilty-misc</a> package.

The <a class="external text" data-href="https://github.com/Whonix/usability-misc/blob/master/etc/sudoers.d/tunnel_unpriv" href="https://github.com/Whonix/usability-misc/blob/master/etc/sudoers.d/tunnel_unpriv" rel="noreferrer noopener" target="_blank">/etc/sudoers.d/tunnel_unpriv</a> wrapper script is being provided by the <a class="external text" data-href="https://github.com/Whonix/usability-misc" href="https://github.com/Whonix/usability-misc" rel="noreferrer noopener" target="_blank">usabilty-misc</a> package.

The <a class="external text" data-href="https://github.com/Whonix/usability-misc/blob/master/lib/systemd/system/openvpn%40openvpn.service.d/50_unpriv.conf" href="https://github.com/Whonix/usability-misc/blob/master/lib/systemd/system/openvpn%40openvpn.service.d/50_unpriv.conf" rel="noreferrer noopener" target="_blank">/lib/systemd/system/openvpn@openvpn.service.d/50_unpriv.conf</a> wrapper script is being provided by the <a class="external text" data-href="https://github.com/Whonix/usability-misc" href="https://github.com/Whonix/usability-misc" rel="noreferrer noopener" target="_blank">usabilty-misc</a> package.</span>
</li>
<li id="cite_note-15"><span class="mw-cite-backlink"><a href="#cite_ref-15">↑</a></span> <span class="reference-text">We must run OpenVPN as user 'tunnel', because that is the only user besides user <i><span style="background-color:#FBFBFB">clearnet</span></i> that will be allowed to establish external connections when using Whonix Firewall setting VPN_FIREWALL=1.</span>
</li>
<li id="cite_note-16"><span class="mw-cite-backlink"><a href="#cite_ref-16">↑</a></span> <span class="reference-text">
<i>/etc/openvpn/update-resolv-conf</i> uses resolvconf.

resolvconf needs to be installed for the lines beginning with <i>script-security</i>, <i>up</i>, and <i>down</i> to function properly.</span>
</li>
<li id="cite_note-17"><span class="mw-cite-backlink"><a href="#cite_ref-17">↑</a></span> <span class="reference-text">
In the <i>/etc/openvpn/openvpn.conf</i> file, change the following text.

<pre>script-security 2
up "/etc/openvpn/update-resolv-conf script_type=up dev=tun0"
down "/etc/openvpn/update-resolv-conf script_type=down dev=tun0"
</pre>
<p>To the following. Remove or comment out the lines beginning with "up" and "down", and change the 2 to a 1.
</p>
<pre>script-security 1
</pre>
<p>Open <i><span style="background-color:#FBFBFB">/etc/resolv.conf</span></i> in an editor with root rights.
</p>
<div style="background: #F8F8F8; border: 2px; padding: 5px; margin: 10px; border-style: solid; border-color: black; width: 100%">
<p><u>If you are using a graphical Whonix or <a data-href="/wiki/Qubes" href="../Qubes.html" title="Qubes">Qubes-Whonix</a></u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>kdesudo kwrite /etc/resolv.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">kdesudo kwrite /etc/resolv.conf</textarea>
</div>
</div>
<p><u>If you are using a terminal-only Whonix</u>, run.
</p><div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>sudo nano /etc/resolv.conf</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">sudo nano /etc/resolv.conf</textarea>
</div>
</div>
</div>
<p>Comment out.
</p>
<pre>#nameserver 10.152.152.10
</pre>
<p>Add.
</p>
<pre>## Riseup.net OpenVPN DNS server
nameserver 172.27.100.1
</pre>
<p>If Riseup is not being used, replace 172.27.100.1 with the virtual LAN IP address of the VPN provider's DNS server. If unsure, the VPN provider might provide it. Users can also try to infer it by running <i>sudo route</i> after successfully connecting to the VPN. The first destination default gateway should also function as a DNS server.
</p><p>Save and exit.
</p><p>Users who want to prevent <i>/etc/resolv.conf</i> being overwritten by other packages like DHCP or resolvconf should run.
</p>
<pre>sudo chattr +i /etc/resolv.conf
</pre>
<p>In order to revert this change, use <i>-i</i>.
</p><p>Ignore the <i>/etc/resolv.conf</i> instructions below.
</p>
</span></li>
<li id="cite_note-Whonix14-18"><span class="mw-cite-backlink">↑ <sup><a href="#cite_ref-Whonix14_18-0">18.0</a></sup> <sup><a href="#cite_ref-Whonix14_18-1">18.1</a></sup></span> <span class="reference-text">Removeable in Whonix 14 since merged in usablity-misc package.</span>
</li>
<li id="cite_note-19"><span class="mw-cite-backlink"><a href="#cite_ref-19">↑</a></span> <span class="reference-text">
This is done to prevent the old DNS server being used.
For further discussion of this issue, see:
<a class="external free" data-href="https://github.com/adrelanos/vpn-firewall/issues/16" href="https://github.com/adrelanos/vpn-firewall/issues/16" rel="noreferrer noopener" target="_blank">https://github.com/adrelanos/vpn-firewall/issues/16</a></span>
</li>
<li id="cite_note-20"><span class="mw-cite-backlink"><a href="#cite_ref-20">↑</a></span> <span class="reference-text">
So changes in <i>/etc/resolvconf/run/interface/original.resolvconf</i> from chapter <a href="#DNS_Configuration">#DNS Configuration</a> take effect.</span>
</li>
<li id="cite_note-21"><span class="mw-cite-backlink"><a href="#cite_ref-21">↑</a></span> <span class="reference-text">These is the standard Whonix DNS server.</span>
</li>
<li id="cite_note-22"><span class="mw-cite-backlink"><a href="#cite_ref-22">↑</a></span> <span class="reference-text">These are standard Qubes DNS servers.</span>
</li>
<li id="cite_note-nodns-23"><span class="mw-cite-backlink">↑ <sup><a href="#cite_ref-nodns_23-0">23.0</a></sup> <sup><a href="#cite_ref-nodns_23-1">23.1</a></sup></span> <span class="reference-text">
In case you have no functional system DNS, you could also alternatively just test TCP.

The IP <i><span style="background-color:#FBFBFB">138.201.14.212</span></i> might change. You can find out the current one by running the following command inside a VM that has functional system DNS. (Ideally inside a Whonix-Workstation.)

<pre>nslookup check.torproject.org
</pre></span>
</li>
<li id="cite_note-24"><span class="mw-cite-backlink"><a href="#cite_ref-24">↑</a></span> <span class="reference-text">
<div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>UWT_DEV_PASSTHROUGH=1 curl --silent --tlsv1.2 --proto =https -H 'Host: check.torproject.org' -k https://138.201.14.212 | grep IP</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">UWT_DEV_PASSTHROUGH=1 curl --silent --tlsv1.2 --proto =https -H 'Host: check.torproject.org' -k https://138.201.14.212 | grep IP</textarea>
</div>
</div></span>
</li>
<li id="cite_note-25"><span class="mw-cite-backlink"><a href="#cite_ref-25">↑</a></span> <span class="reference-text">
<div class="codeContainer">
<div class="selectBtnDiv">
<div class="smallText"><a class="selectLink" href="#" onclick="SelectText(this.parentNode.parentNode.parentNode.children[2].children[0]); return false;">[select code]</a></div>
</div>
<div class="preDiv">
<pre>curl --silent --tlsv1.2 --proto =https -H 'Host: check.torproject.org' -k https://138.201.14.212 | grep IP</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxArea" readonly="readonly" rows="1">curl --silent --tlsv1.2 --proto =https -H 'Host: check.torproject.org' -k https://138.201.14.212 | grep IP</textarea>
</div>
</div></span>
</li>
</ol></div></div>
<hr/>
<div style="padding-bottom:1px; padding-top:6px; border:thin solid black; background:#EEEEEE; text-align:center;"><u>Random News:</u>
<p>Did you know that anyone can edit the <a class="external text" data-href="https://www.whonix.org" href="https://www.whonix.org" rel="noreferrer noopener" target="_blank">Whonix wiki</a> to improve it?
</p>
</div>
<hr/><p><font size="-1"><a class="external text" data-href="../Tunnels/Connecting_to_Tor_before_a_VPN" href="../Tunnels/Connecting_to_Tor_before_a_VPN" rel="noreferrer noopener" target="_blank">https</a> | (<a data-href="/wiki/Forcing_.onion_on_Whonix.org" href="../Forcing_.onion_on_Whonix.org.html" title="Forcing .onion on Whonix.org">forcing</a>) <a class="external text" data-href="http://dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/wiki/Tunnels/Connecting_to_Tor_before_a_VPN" href="http://dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/wiki/Tunnels/Connecting_to_Tor_before_a_VPN" rel="noreferrer noopener" target="_blank">onion</a><br/>
</font></p><font size="-1"></font><p><font size="-1">Share: <a data-href="https://twitter.com/intent/tweet?url=../Tunnels/Connecting_to_Tor_before_a_VPN&amp;text=&amp;via=Whonix" href="https://twitter.com/intent/tweet?url=../Tunnels/Connecting_to_Tor_before_a_VPN&amp;text=&amp;via=Whonix">Twitter</a>
|
<a data-href="https://facebook.com/sharer.php?u=../Tunnels/Connecting_to_Tor_before_a_VPN" href="https://facebook.com/sharer.php?u=../Tunnels/Connecting_to_Tor_before_a_VPN">Facebook</a></font>
</p><p><font size="-1">This is a wiki. Want to improve this page? Help is welcome and volunteer contributions are happily considered! See <a class="external text" data-href="https://github.com/Whonix/Whonix/blob/master/CONTRIBUTING.md" href="https://github.com/Whonix/Whonix/blob/master/CONTRIBUTING.md" rel="noreferrer noopener" target="_blank">Conditions for Contributions to Whonix</a>, then <a data-href="/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit" href="https://www.whonix.org/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;action=edit">Edit</a>! IP addresses are scrubbed, but editing over Tor is recommended. Edits are held for moderation.</font>
</p><p><font size="-1">Whonix is a <a class="external text" data-href="http://www.openinventionnetwork.com/licensees.php" href="http://www.openinventionnetwork.com/licensees.php" rel="noreferrer noopener" target="_blank">licensee</a> of the Open Invention Network. Unless otherwise noted, the content of this page is <a data-href="/wiki/Whonix:Copyrights" href="../Whonix:Copyrights.html" title="Whonix:Copyrights">copyrighted</a> and licensed under the same Libre Software <a class="external text" data-href="https://github.com/Whonix/Whonix/blob/master/debian/copyright" href="https://github.com/Whonix/Whonix/blob/master/debian/copyright" rel="noreferrer noopener" target="_blank">license</a> as Whonix itself. (<a data-href="/wiki/Why_Whonix_is_Free_Software" href="../Why_Whonix_is_Free_Software.html" title="Why Whonix is Free Software">Why?</a>)</font>
</p>
<!-- 
NewPP limit report
Cached time: 20180924054818
Cache expiry: 0
Dynamic content: true
CPU time usage: 0.460 seconds
Real time usage: 0.486 seconds
Preprocessor visited node count: 2768/1000000
Preprocessor generated node count: 7533/1000000
Post‐expand include size: 86869/2097152 bytes
Template argument size: 29460/2097152 bytes
Highest expansion depth: 19/40
Expensive parser function count: 0/100
Unstrip recursion depth: 1/20
Unstrip post‐expand size: 19218/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%  331.363      1 -total
 76.94%  254.954     21 Template:Box
 34.58%  114.570     38 Template:CodeSelect
 25.76%   85.375      1 Template:Prevent_Bypassing_the_Tunnel-Link
 23.16%   76.748     11 Template:Open_with_root_rights
 19.52%   64.674      1 Template:Disable_Stream_Isolation_Easy
 17.06%   56.529      3 Template:Mbox
 14.59%   48.348      3 Template:Ambox
 13.40%   44.404      1 Template:Tunnels_Introduction
 11.02%   36.525      1 Template:Reflist
-->
</div></div><div class="printfooter">
Retrieved from "<a data-href="http://kkkkkkkkkk63ava6.onion/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;oldid=36982" dir="ltr" href="http://kkkkkkkkkk63ava6.onion/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;oldid=36982">http://kkkkkkkkkk63ava6.onion/w/index.php?title=Tunnels/Connecting_to_Tor_before_a_VPN&amp;oldid=36982</a>"</div>
<div class="clear_both"></div>
</div>
<div class="group"><div class="catlinks" data-mw="interface" id="catlinks"><div class="mw-normal-catlinks" id="mw-normal-catlinks"><a data-href="/wiki/Special:Categories" href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a data-href="/wiki/Category:Documentation" href="../Category:Documentation.html" title="Category:Documentation">Documentation</a></li></ul></div></div></div>
</div>
</div>
</div>
<footer class="row">
<div id="footer">
<div class="small-12 large-centered columns text-center" id="footer-left">
<ul id="footer-left">
<li id="footer-lastmod"> This page was last edited on 16 September 2018, at 09:02.</li>
<li id="footer-Priority_Support"><a data-href="/wiki/Priority_Support" href="../Priority_Support.html" title="Priority Support">Priority Support</a></li>
<li id="footer-Investors"><a data-href="/wiki/Investors" href="../Investors.html" title="Investors">Investors</a></li>
<li id="footer-Professional_Support"><a data-href="/wiki/Professional_Support" href="../Professional_Support.html" title="Professional Support">Professional Support</a></li>
</ul>
</div>
<div class="large-12 small-12 columns" id="footer-right-icons">
<ul id="poweredby">
</ul>
</div>
</div>
</footer>
</div>

</body>
<!-- Cached/compressed 20180924054818 -->
</html>
