<!DOCTYPE html>
<html class="client-nojs" dir="ltr" lang="en"><!-- 
 single html processed by https://github.com/zTrix/webpage2html
 title: Dev/latency-obfuscator - Whonix
 url: ../Dev/latency-obfuscator
 date: Sun Sep 13 07:39:52 2020
-->
<head>
<meta charset="utf-8"/>
<title>Dev/latency-obfuscator - Whonix</title>
<link rel="stylesheet" type="text/css" href="../style.css">



<meta content="" name="ResourceLoaderDynamicStyles"/>
<meta content="MediaWiki 1.34.1" name="generator"/>
<meta content="width=device-width, user-scalable=yes, initial-scale=1.0" name="viewport"/>
<link data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=edit" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=edit" rel="alternate.html" title="Edit" type="application/x-wiki"/>
<link data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=edit" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=edit" rel="edit.html" title="Edit"/>
<link data-href="/w/images/favicon.ico" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOPj4wC5q6j/xba0/8W2tP+3qab/4+PiBQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALyurP/Ku7n/yru5/8q7uf/Ku7n/yru5/8q7uf+6rKr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALyurP/Ku7n/yru5/8CohP/VnhL/1Z4S/8CohP/Ku7n/yru5/7mrqf8AAAAAAAAAAAAAAAAAAAAAAAAAAI6Mi//Ku7n/yru5/8GRHP/iqhL/////////////////wJEd/8q7uf/Ku7n/xsXE/wAAAAAAAAAAAAAAAAAAAAC5q6n/yru5/8q7uf/hqRH//////0bcy/9G3Mv//////+GpEf/Ku7n/yru5/7qsqv8AAAAAAAAAAAAAAAAAAAAAxLW0/8q7uf/Ku7n/4qoS/////////////////0bcy//iqhL/yru5/8q7uf/Gt7T/AAAAAAAAAAAAAAAAAAAAAMKzsP/Ku7n/yru5/96lFf//////RtzL/0bcy///////3qUV/8q7uf/Ku7n/wrWy/wAAAAAAAAAAAAAAAAAAAACvo6D/yru5/8q7uf/Ku7n/4akQ//fnvP/57tD/4akQ/8q7uf/Ku7n/yru5/7Gkov8AAAAAAAAAAAAAAAAAAAAAAAAAAMq7uf/Ku7n/yru5/8q7uf/hqRD/4akQ/8q7uf/Ku7n/yru5/8q7uf8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACOjIv/yru5/8q7uf/Ku7n/yru5/8q7uf/Ku7n/yru5/8q7uf+Mioj/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAISDgf/Iurj/yru5/8q7uf/Ku7n/yru5/8i5uP+EgoH/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC6rKr/q56c/wAAAACOjIv/joyL/wAAAACom5r/taim/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAuqyp/66hnv8AAAAAAAAAAAAAAAAAAAAAqp2b/7SnpP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKmcm/+9r6z/AAAAAAAAAAAAAAAAAAAAALmrqf+jl5b/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwLOw/6uenP8AAAAAAAAAAKqenP+/sq//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACtoJ7/vK2r/72vrP+sn57/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/D8AAPAPAADgBwAAwAMAAMADAADAAwAAwAMAAMADAADgBwAA4AcAAPAPAADyTwAA888AAPPPAAD5nwAA/D8AAA==" rel="shortcut icon"/>
<link data-href="/w/opensearch_desc.php" href="https://www.whonix.org/w/opensearch_desc.php" rel="search.html" title="Whonix (en)" type="application/opensearchdescription+xml"/>
<link data-href="//www.whonix.org/w/api.php?action=rsd" href="https://www.whonix.org/w/api.php?action=rsd" rel="EditURI" type="application/rsd+xml"/>
<link data-href="/w/index.php?title=Special:RecentChanges&amp;feed=atom" href="https://www.whonix.org/w/index.php?title=Special:RecentChanges&amp;feed=atom" rel="alternate.html" title="Whonix Atom feed" type="application/atom+xml"/>
<meta content="Dev/latency-obfuscator - Whonix" property="og:title"/>
<meta content="Whonix" property="og:site_name"/>
<meta content="../Dev/latency-obfuscator" property="og:url"/>
<meta content="" property="og:image"/>
<meta content="2020-08-13T07:58:40Z" property="article:modified_time"/>
<meta content="2020-08-13T07:58:40Z" property="article:published_time"/>
<meta content="@Whonix" property="twitter:site"/>
<meta content="Dev/latency-obfuscator - Whonix" property="twitter:title"/>
<meta content="" property="twitter:image"/>
<meta content="summary_large_image" property="twitter:card"/>

<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<!--[if lt IE 9]><script src="/w/resources/lib/html5shiv/html5shiv.js"></script><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject mw-editable page-Dev_latency-obfuscator rootpage-Dev skin-foreground action-view"><div class="mw-cookiewarning-container banner-container"><div class="mw-cookiewarning-text"><span>By using our website, you acknowledge that you have read, understood and agreed to our Privacy Policy, Cookie Policy, Terms of Service, and E-Sign Consent.</span> <a data-href="/wiki/Terms_of_Service" href="../Terms_of_Service">More information</a><form method="POST"><input class="mw-cookiewarning-dismiss" name="disablecookiewarning" type="submit" value="OK"/></form></div></div><div id="navwrapper">

</div>
<div id="page-content">
<div class="row">
<div class="large-12 columns">
<div class="mw-indicators mw-body-content">
</div>
<!--[if lt IE 9]>
				<div id="siteNotice" class="sitenotice panel radius">Whonix may not look as expected in this version of Internet Explorer. We recommend you upgrade to a newer version of Internet Explorer or switch to a browser like Firefox or Chrome.</div>
				<![endif]-->
<div class="sitenotice" id="siteNotice"><div dir="ltr" id="localNotice" lang="en"><p>
</p><div id="banner">
<a class="cn-full-banner-click" data-href="/wiki/Donate" href="../Donate.html" title="">
<div id="banner-logo"></div>
<div id="black-text">
<span>Please Donate!</span>
</div>
</a>
</div>
<p>
</p></div></div> </div>
</div>
<div id="mw-js-message" style="display:none;"></div>
<div class="row">
<div class="large-12 columns" id="p-cactions">
<a class="button small secondary radius" data-dropdown="actions" data-options="align:left; is_hover: true; hover_timeout:700" href="#" id="actions-button"><i class="fa fa-cog"><span class="show-for-medium-up"> Actions</span></i></a>
<ul class="f-dropdown" data-dropdown-content="" id="actions">
<li class="selected" id="ca-nstab-main"><a accesskey="c" data-href="latency-obfuscator" href="../Dev/latency-obfuscator.html" title="View the content page [c]">Page</a></li><li class="new" id="ca-talk"><a accesskey="t" data-href="/w/index.php?title=Talk:Dev/latency-obfuscator&amp;action=edit&amp;redlink=1" href="https://www.whonix.org/w/index.php?title=Talk:Dev/latency-obfuscator&amp;action=edit&amp;redlink=1" rel="discussion.html" title="Discussion about the content page (page does not exist) [t]">Discussion</a></li><li id="ca-edit"><a accesskey="e" data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=edit" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=edit.html" title="Edit this page [e]">Edit</a></li><li id="ca-history"><a accesskey="h" data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=history" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=history.html" title="Past revisions of this page [h]">History</a></li> </ul>
<div id="content">
<h1 class="title" id="firstHeading">Dev/latency-obfuscator</h1>
<h3 id="tagline">From Whonix</h3> <h5 class="subtitle" id="siteSub"><span class="subpages">&lt; <a class="mw-redirect" data-href="/wiki/Dev" href="../Dev.html" title="Dev">Dev</a></span></h5>
<div class="clear_both" id="contentSub"></div>
<div class="mw-bodytext" id="bodyContent">
<div class="mw-content-ltr" dir="ltr" id="mw-content-text" lang="en"><div class="mw-parser-output"><p><b>This page is Obsolete since not needed. See <a data-href="/wiki/Advanced_Deanonymization_Attacks" href="../Advanced_Deanonymization_Attacks.html" title="Advanced Deanonymization Attacks">Advanced_Deanonymization_Attacks</a> for explanation.</b>
</p>
<div class="toc" id="toc"><input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/><div class="toctitle" dir="ltr" lang="en"><h2>Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Latency-Obfuscator"><span class="tocnumber">1</span> <span class="toctext">Latency-Obfuscator</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Summary"><span class="tocnumber">1.1</span> <span class="toctext">Summary</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Implementation_Details"><span class="tocnumber">1.2</span> <span class="toctext">Implementation Details</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Relevant_Commands_and_Testing"><span class="tocnumber">1.3</span> <span class="toctext">Relevant Commands and Testing</span></a></li>
</ul>
</li>
</ul>
</div>
<h1><span class="mw-headline" id="Latency-Obfuscator">Latency-Obfuscator</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=1" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=1.html" title="Edit section: Latency-Obfuscator">edit</a><span class="mw-editsection-bracket">]</span></span></h1>
<h2><span class="mw-headline" id="Summary">Summary</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=2" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=2.html" title="Edit section: Summary">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>This package is supposed to implement the mitigation discussed in <a class="external free" data-href="https://phabricator.whonix.org/T530" href="https://phabricator.whonix.org/T530" rel="noreferrer noopener" target="_blank">https://phabricator.whonix.org/T530</a> <sup><a data-href="https://web.archive.org/web/https://phabricator.whonix.org/T530" href="https://web.archive.org/web/https://phabricator.whonix.org/T530" rel="noreferrer noopener" target="_blank">[archive]</a></sup> using tc netem. Package WIP at <a class="external free" data-href="https://github.com/HulaHoop0/latency-obfuscator" href="https://github.com/HulaHoop0/latency-obfuscator" rel="noreferrer noopener" target="_blank">https://github.com/HulaHoop0/latency-obfuscator</a> <sup><a data-href="https://web.archive.org/web/https://github.com/HulaHoop0/latency-obfuscator" href="https://web.archive.org/web/https://github.com/HulaHoop0/latency-obfuscator" rel="noreferrer noopener" target="_blank">[archive]</a></sup>
</p><p>Packet latency (as observed by an adversary outside Tor) drops significantly when the CPU is stressed as can be observed in ICMP and TCP traffic. This is caused by c-state transitions. Non-solutions: Running a stress process with a high nice-level or disabling c-state because both solutions would heavily impact battery life and CPU temperature.
</p><p>The chosen solution is to add a random delay per packet to mask the this effect for best results.
</p><p><br/>
</p>
<h2><span class="mw-headline" id="Implementation_Details">Implementation Details</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=3" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=3.html" title="Edit section: Implementation Details">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<ul><li>Use of /etc/NetworkManager/dispatcher.d hooks to run the tc command whenever any NIC goes up: <a class="external free" data-href="https://askubuntu.com/questions/1111652/network-manager-script-when-interface-up" href="https://askubuntu.com/questions/1111652/network-manager-script-when-interface-up" rel="noreferrer noopener" target="_blank">https://askubuntu.com/questions/1111652/network-manager-script-when-interface-up</a> <sup><a data-href="https://web.archive.org/web/https://askubuntu.com/questions/1111652/network-manager-script-when-interface-up" href="https://web.archive.org/web/https://askubuntu.com/questions/1111652/network-manager-script-when-interface-up" rel="noreferrer noopener" target="_blank">[archive]</a></sup></li></ul>
<ul><li>Interface names must be filtered to exclude <code>lo</code> <code>virbr*</code> devices or virtual environments and local daemons will incur a needless penalty.</li></ul>
<ul><li>No need to react to "down" events because tc remains running in cases where the NIC goes down then up again. It declares "Error: Exclusivity flag on, cannot modify." in that situation when the command is re-run again.</li></ul>
<ul><li>The limit parameter must be <a class="external text" data-href="https://stackoverflow.com/questions/18792347/what-does-option-limit-in-tc-netem-mean-and-do" href="https://stackoverflow.com/questions/18792347/what-does-option-limit-in-tc-netem-mean-and-do" rel="noreferrer noopener" target="_blank">raised</a> <sup><a data-href="https://web.archive.org/web/https://stackoverflow.com/questions/18792347/what-does-option-limit-in-tc-netem-mean-and-do" href="https://web.archive.org/web/https://stackoverflow.com/questions/18792347/what-does-option-limit-in-tc-netem-mean-and-do" rel="noreferrer noopener" target="_blank">[archive]</a></sup> from the default of 1000 or else packets get dropped as traffic demand increases. 12500 covers connection speeds of up to 1Gbps.</li></ul>
<ul><li><code>sudo tc qdisc</code> indicates all the default queues setup for interfaces on Linux</li></ul>
<ul><li>Info on various qdisc filter properties: <a class="external free" data-href="https://wiki.archlinux.org/index.php/advanced_traffic_control" href="https://wiki.archlinux.org/index.php/advanced_traffic_control" rel="noreferrer noopener" target="_blank">https://wiki.archlinux.org/index.php/advanced_traffic_control</a> <sup><a data-href="https://web.archive.org/web/https://wiki.archlinux.org/index.php/advanced_traffic_control" href="https://web.archive.org/web/https://wiki.archlinux.org/index.php/advanced_traffic_control" rel="noreferrer noopener" target="_blank">[archive]</a></sup></li></ul>
<h2><span class="mw-headline" id="Relevant_Commands_and_Testing">Relevant Commands and Testing</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a data-href="/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=4" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;action=edit&amp;section=4.html" title="Edit section: Relevant Commands and Testing">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<ul><li>Setup a VPN connection in Whonix WS then run ping &lt;foo&gt;.com</li></ul>
<ul><li>Simulate CPU load with stress <code>ctrl + c</code> to stop:</li></ul>
<p>
</p><div class="codeContainerNew">
<div class="preDiv">
<pre>sudo apt install stress
stress -c 4</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxAreaNew" onfocus="this.select()" readonly="" rows="1">sudo apt install stress
stress -c 4</textarea>
</div>
</div>
<p>
You will notice latency markedly dropping and staying there.
</p>
<ul><li>Run this command for mitigation. It will mask the latency patterns induced by the <code>stress</code> command:</li></ul>
<p>
</p><div class="codeContainerNew">
<div class="preDiv">
<pre>sudo tc qdisc add dev eth0 root netem limit 12500 slot 75ms 200ms packets 1</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxAreaNew" onfocus="this.select()" readonly="" rows="1">sudo tc qdisc add dev eth0 root netem limit 12500 slot 75ms 200ms packets 1</textarea>
</div>
</div>
<p>
</p>
<ul><li>To test with <a class="external text" data-href="https://serverfault.com/questions/14376/ping-alternative-for-tcp" href="https://serverfault.com/questions/14376/ping-alternative-for-tcp" rel="noreferrer noopener" target="_blank">TCP ping</a> <sup><a data-href="https://web.archive.org/web/https://serverfault.com/questions/14376/ping-alternative-for-tcp" href="https://web.archive.org/web/https://serverfault.com/questions/14376/ping-alternative-for-tcp" rel="noreferrer noopener" target="_blank">[archive]</a></sup>:</li></ul>
<p>
</p><div class="codeContainerNew">
<div class="preDiv">
<pre>sudo apt install hping3
sudo hping3 -S -p 80 www.sunet.se</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxAreaNew" onfocus="this.select()" readonly="" rows="1">sudo apt install hping3
sudo hping3 -S -p 80 www.sunet.se</textarea>
</div>
</div>
<p>
</p>
<ul><li>For <a class="external text" data-href="https://serverfault.com/questions/794948/how-to-check-all-active-netem-rules" href="https://serverfault.com/questions/794948/how-to-check-all-active-netem-rules" rel="noreferrer noopener" target="_blank">checking</a> <sup><a data-href="https://web.archive.org/web/https://serverfault.com/questions/794948/how-to-check-all-active-netem-rules" href="https://web.archive.org/web/https://serverfault.com/questions/794948/how-to-check-all-active-netem-rules" rel="noreferrer noopener" target="_blank">[archive]</a></sup> queue properties/<a class="external text" data-href="https://tldp.org/en/Traffic-Control-HOWTO/ar01s06.html" href="https://tldp.org/en/Traffic-Control-HOWTO/ar01s06.html" rel="noreferrer noopener" target="_blank">details</a> <sup><a data-href="https://web.archive.org/web/https://tldp.org/en/Traffic-Control-HOWTO/ar01s06.html" href="https://web.archive.org/web/https://tldp.org/en/Traffic-Control-HOWTO/ar01s06.html" rel="noreferrer noopener" target="_blank">[archive]</a></sup>:</li></ul>
<p>
</p><div class="codeContainerNew">
<div class="preDiv">
<pre>sudo tc qdisc</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxAreaNew" onfocus="this.select()" readonly="" rows="1">sudo tc qdisc</textarea>
</div>
</div>
<p>
</p><div class="codeContainerNew">
<div class="preDiv">
<pre>sudo tc -s qdisc ls dev eth0</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxAreaNew" onfocus="this.select()" readonly="" rows="1">sudo tc -s qdisc ls dev eth0</textarea>
</div>
</div>
<p>
</p>
<ul><li>To detach tc from the interface</li></ul>
<p>
</p><div class="codeContainerNew">
<div class="preDiv">
<pre>sudo tc qdisc delete dev eth0 root</pre>
</div>
<div class="textareaDiv">
<textarea class="codeBoxAreaNew" onfocus="this.select()" readonly="" rows="1">sudo tc qdisc delete dev eth0 root</textarea>
</div>
</div>
<p>
</p>
</div></div><div class="printfooter">
Retrieved from "<a data-href="/w/index.php?title=Dev/latency-obfuscator&amp;oldid=59148" dir="ltr" href="https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;oldid=59148">https://www.whonix.org/w/index.php?title=Dev/latency-obfuscator&amp;oldid=59148</a>"</div>
<div class="clear_both"></div>
</div>
<div class="group"><div class="catlinks catlinks-allhidden" data-mw="interface" id="catlinks"></div></div>
</div>
</div>
</div>
<footer class="row">
<div id="footer">
<div class="small-12 large-centered columns text-center" id="footer-left">
<ul id="footer-left">
<li id="footer-lastmod"> This page was last edited on 13 August 2020, at 09:58.</li>
<li id="footer-Imprint"><a data-href="/wiki/Imprint" href="../Imprint.html" title="Imprint">Imprint</a></li>
<li id="footer-Privacy_Policy"><a data-href="/wiki/Privacy_Policy" href="../Privacy_Policy.html" title="Privacy Policy">Privacy Policy</a></li>
<li id="footer-Cookie_Policy"><a data-href="/wiki/Cookie_Policy" href="../Cookie_Policy.html" title="Cookie Policy">Cookie Policy</a></li>
<li id="footer-Terms_of_Service"><a data-href="/wiki/Terms_of_Service" href="../Terms_of_Service.html" title="Terms of Service">Terms of Service</a></li>
<li id="footer-DMCA"><a class="mw-redirect" data-href="/wiki/DMCA" href="../DMCA.html" title="DMCA">DMCA</a></li>
<li id="footer-E_Sign_Consent"><a data-href="/wiki/E-Sign_Consent" href="../E-Sign_Consent.html" title="E-Sign Consent">E-Sign Consent</a></li>
<li id="footer-Priority_Support"><a data-href="/wiki/Priority_Support" href="../Priority_Support.html" title="Priority Support">Priority Support</a></li>
<li id="footer-Investors"><a data-href="/wiki/Investors" href="../Investors.html" title="Investors">Investors</a></li>
<li id="footer-Professional_Support"><a data-href="/wiki/Professional_Support" href="../Professional_Support.html" title="Professional Support">Professional Support</a></li>
</ul>
</div>
<div class="large-12 small-12 columns" id="footer-right-icons">
<ul id="poweredby">
</ul>
</div>
</div>
</footer>
</div>

</body>
</html>
